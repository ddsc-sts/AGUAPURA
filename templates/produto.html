{% extends "base.html" %}
{% block title %}{{ produto.nome }} - AQUAPURA{% endblock %}

{% block content %}

<style>
  /* Bot√£o de Favorito - Posicionado pr√≥ximo ao produto */
  .btn-favorito-produto {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid var(--border);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 28px;
    z-index: 100;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  [data-theme="dark"] .btn-favorito-produto {
    background: rgba(30, 41, 59, 0.95);
    border-color: #475569;
  }

  .btn-favorito-produto:hover {
    transform: scale(1.15);
    box-shadow: 0 6px 25px rgba(239, 68, 68, 0.4);
  }

  .btn-favorito-produto.favoritado {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-color: #ef4444;
    color: white;
  }

  .btn-favorito-produto:not(.favoritado) {
    color: #94a3b8;
  }

  /* Estilo para estampas selecion√°veis */
  .estampa-option {
    position: relative;
    cursor: pointer;
  }

  .estampa-option input[type="radio"] {
    display: none;
  }

  .estampa-option img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 10px;
    border: 3px solid var(--border);
    transition: all 0.3s ease;
  }

  .estampa-option input[type="radio"]:checked + img {
    border-color: var(--azul);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    transform: scale(1.05);
  }

  .estampa-option:hover img {
    border-color: var(--azul);
    opacity: 0.8;
  }

  /* Indicador de sele√ß√£o */
  .estampa-option input[type="radio"]:checked ~ .check-icon {
    opacity: 1;
    transform: scale(1);
  }

  .check-icon {
    position: absolute;
    top: 5px;
    right: 5px;
    background: var(--azul);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    opacity: 0;
    transform: scale(0);
    transition: all 0.3s ease;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .btn-favorito-produto {
      width: 50px;
      height: 50px;
      font-size: 24px;
      top: 15px;
      right: 15px;
    }
  }
</style>

<section class="produto-pagina" style="padding:40px 5%; position: relative;">
  
  <!-- ‚úÖ BOT√ÉO DE FAVORITO (dentro da section, posi√ß√£o absoluta) -->
  {% if session.get("logado") %}
  <form action="{% if is_favorito(produto.id) %}{{ url_for('remover_favorito', produto_id=produto.id) }}{% else %}{{ url_for('adicionar_favorito', produto_id=produto.id) }}{% endif %}" 
        method="post"
        style="position: absolute; top: 20px; right: 5%; z-index: 100;">
    <button type="submit" 
            class="btn-favorito-produto {% if is_favorito(produto.id) %}favoritado{% endif %}"
            title="{% if is_favorito(produto.id) %}Remover dos favoritos{% else %}Adicionar aos favoritos{% endif %}">
      {% if is_favorito(produto.id) %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
    </button>
  </form>
  {% endif %}

  <div class="produto-container">

    <!-- IMAGEM PRINCIPAL -->
    <div class="produto-imagem" style="min-width:320px;">
      <img id="mainImage" src="{{ produto.imagem_principal }}" alt="{{ produto.nome }}"
           style="width:100%; border-radius:12px; object-fit:cover;">

      {% if imagens %}
      <div style="display:flex; gap:10px; margin-top:12px; justify-content:center; flex-wrap:wrap;">
        {% for img in imagens %}
        <img class="thumb" src="{{ img.imagem }}" alt="foto {{ loop.index }}"
             style="width:72px; height:72px; object-fit:cover; border-radius:8px; cursor:pointer; border:1px solid var(--border);">
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- INFO DO PRODUTO -->
    <div class="produto-info">
      <h1 class="produto-titulo">{{ produto.nome }}</h1>

      <p class="produto-preco">R$ {{ "%.2f"|format(produto.preco) }}</p>

      {% if produto.descricao %}
      <p class="produto-descricao">{{ produto.descricao }}</p>
      {% endif %}

      <!-- PERSONALIZAR (n√£o aparece em acess√≥rios) -->
      {% if produto.categoria != "Acess√≥rio" %}
      <div style="margin-top:18px;">
        <button id="btnPersonalizar" class="btn-personalizar" type="button">Personalizar ‚úèÔ∏è</button>
      </div>
      {% endif %}

      <!-- FORM PRINCIPAL -->
      <form id="addCartForm" method="post" action="{{ url_for('add_carrinho', produto_id=produto.id) }}">

        {% if produto.categoria != "Acess√≥rio" %}
        <!-- BOX DE PERSONALIZA√á√ÉO -->
        <div id="personalizarBox" class="personalizar-box"
             style="display:none; margin-top:20px; padding:20px; background:var(--card-bg); border:1px solid var(--border); border-radius:12px;">
          
          <!-- NOME PERSONALIZADO -->
          <div style="margin-bottom:20px;">
            <label style="font-weight:600; color:var(--texto); display:block; margin-bottom:8px;">Nome Personalizado</label>
            <input id="nomePersonalizado" name="personalizacao" type="text"
                   placeholder="Ex: Maria"
                   style="padding:10px; border-radius:10px; border:1px solid var(--border); width:100%; font-size:1rem;">
            <p style="font-size:0.85rem; color:var(--texto); opacity:0.7; margin-top:5px;">üí° Adicione um nome para personalizar seu produto</p>
          </div>

          <!-- ESTAMPAS -->
          <div>
            <label style="font-weight:600; color:var(--texto); display:block; margin-bottom:10px;">
              Escolha uma estampa <span style="color:var(--azul);">(+ R$ 20,00)</span>
            </label>

            <div style="display:flex; gap:12px; flex-wrap:wrap;">
              {% for estampa in ['estampa1.png','estampa2.png','estampa3.png','estampa4.png'] %}
              <label class="estampa-option">
                <input type="radio" name="estampa" value="{{ estampa }}">
                <img src="/static/estampas/{{ estampa }}" alt="Estampa {{ loop.index }}">
                <span class="check-icon">‚úì</span>
              </label>
              {% endfor %}
            </div>
            <p style="font-size:0.85rem; color:var(--texto); opacity:0.7; margin-top:8px;">‚ú® Clique em uma estampa para selecionar</p>
          </div>
        </div>

        <!-- CORES -->
        {% if produto.categoria in ["Copo", "Garrafa"] %}
        <div style="margin-top:18px;">
          <label style="font-weight:600; color:var(--texto);">Escolha a cor:</label>
          <select name="cor" required
                  style="padding:10px; width:180px; margin-top:6px; border-radius:10px; border:1px solid var(--border);">
            <option value="Preto">Preto</option>
            <option value="Branco">Branco</option>
            <option value="Cinza">Cinza</option>
            <option value="Vermelho">Vermelho</option>
            <option value="Azul">Azul</option>
            <option value="Verde">Verde</option>
            <option value="Amarelo">Amarelo</option>
            <option value="Roxo">Roxo</option>
            <option value="Rosa">Rosa</option>
            <option value="Laranja">Laranja</option>
            <option value="Marrom">Marrom</option>
            <option value="Dourado">Dourado</option>
            <option value="Prata">Prata</option>
          </select>
        </div>
        {% endif %}
        {% endif %}

        <!-- QUANTIDADE -->
        <div style="display:flex; align-items:center; gap:10px; margin-top:14px;">
          <label style="font-weight:600;">Quantidade</label>

          <div class="quantidade">
              <button type="button" id="qtyMinus"
                      style="width:36px; height:36px; border-radius:50%; border:none;
                             background:var(--azul); color:var(--card-bg); cursor:pointer;">-</button>

              <input
                  id="qtyInput"
                  name="quantidade"
                  value="1"
                  min="1"
                  max="{{ produto.estoque }}"
                  type="number"
                  style="width:56px; text-align:center; padding:6px; border-radius:8px; border:1px solid var(--border);">

              <button type="button" id="qtyPlus"
                      style="width:36px; height:36px; border-radius:50%; border:none;
                             background:var(--azul); color:var(--card-bg); cursor:pointer;">+</button>
          </div>
        </div>

        <!-- BOT√ÉO ADICIONAR -->
        <div style="margin-top:18px;">
          <button type="submit" class="btn-add-carrinho"
                  style="padding:12px 22px;">Adicionar ao carrinho</button>
        </div>

      </form>

      <p style="margin-top:14px; color:var(--texto); opacity:0.8;">
        Em estoque: <strong>{{ produto.estoque }}</strong>
      </p>
    </div>

  </div>
</section>

<!-- SUGEST√ïES -->
{% if sugestoes %}
<section style="padding:40px 5%; margin-top:20px; text-align:center;">

  {% if produto.categoria in ["Copo", "Garrafa"] %}
    <h2 style="font-size:24px; margin-bottom:20px;">Complete seu kit üõçÔ∏è</h2>
  {% else %}
    <h2 style="font-size:24px; margin-bottom:20px;">Combine com Copos e Garrafas ‚ú®</h2>
  {% endif %}

  <div id="kitContainer" style="display:flex; justify-content:center; gap:25px; flex-wrap:wrap;">
    {% for s in sugestoes %}
    <div style="width:220px; background:var(--card-bg); padding:14px;
                border-radius:12px; box-shadow:0 0 6px #0001; position:relative;">

      <img src="{{ s.imagem_principal }}" style="width:100%; height:180px; object-fit:cover; border-radius:10px;">

      <p style="font-weight:600; margin-top:10px;">{{ s.nome }}</p>
      <p style="color:var(--texto); opacity:0.8;">R$ {{ "%.2f"|format(s.preco) }}</p>

      <label class="kit-opcao" style="margin-top:10px; display:flex; align-items:center; gap:8px; cursor:pointer;">
        <input type="checkbox" class="kit-check" value="{{ s.id }}">
        <span>Incluir no kit</span>
      </label>

      <div class="kit-qtd-box" id="qbox-{{ s.id }}"
           style="margin-top:10px; display:none; align-items:center; gap:8px; justify-content:center;">
        <label style="font-size:0.9rem; font-weight:600;">Qtd:</label>
        <input type="number" class="kit-qtd" data-id="{{ s.id }}" value="1" min="1" max="{{ s.estoque }}"
               style="width:60px; padding:6px; text-align:center; border-radius:8px; border:1px solid var(--azul);">
      </div>

      <p style="font-size:0.8rem; color:var(--texto); opacity:0.7; margin-top:8px;">
        Em estoque: <strong>{{ s.estoque }}</strong>
      </p>

    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const estoqueMax = parseInt("{{ produto.estoque }}") || 0;
  const qtyInput = document.getElementById("qtyInput");

  if (qtyInput) {
    const plusBtn = document.getElementById("qtyPlus");
    const minusBtn = document.getElementById("qtyMinus");

    if (plusBtn) {
      plusBtn.addEventListener("click", () => {
        let atual = parseInt(qtyInput.value || "1");
        if (atual < estoqueMax) qtyInput.value = atual + 1;
      });
    }

    if (minusBtn) {
      minusBtn.addEventListener("click", () => {
        qtyInput.value = Math.max(1, parseInt(qtyInput.value || "1") - 1);
      });
    }

    qtyInput.addEventListener("input", () => {
      const val = parseInt(qtyInput.value) || 1;
      if (val < 1) qtyInput.value = 1;
      if (val > estoqueMax) qtyInput.value = estoqueMax;
    });
  }

  const btnPersonalizar = document.getElementById("btnPersonalizar");
  const personalizarBox = document.getElementById("personalizarBox");

  if (btnPersonalizar && personalizarBox) {
    btnPersonalizar.addEventListener("click", () => {
      if (personalizarBox.style.display === "none" || personalizarBox.style.display === "") {
        personalizarBox.style.display = "block";
        btnPersonalizar.textContent = "Fechar Personaliza√ß√£o ‚úñÔ∏è";
      } else {
        personalizarBox.style.display = "none";
        btnPersonalizar.textContent = "Personalizar ‚úèÔ∏è";
      }
    });
  }

  document.querySelectorAll(".thumb").forEach(thumb => {
    thumb.addEventListener("click", e => {
      const t = e.target;
      if (t && t.src) document.getElementById("mainImage").src = t.src;
    });
  });

  document.querySelectorAll(".kit-check").forEach(chk => {
    chk.addEventListener("change", () => {
      const box = document.getElementById("qbox-" + chk.value);
      if (!box) return;
      box.style.display = chk.checked ? "flex" : "none";
    });
  });

  const form = document.getElementById("addCartForm");
  if (form) {
    form.addEventListener("submit", (e) => {
      document.querySelectorAll('input[name="kit_produtos"]').forEach(x => x.remove());
      document.querySelectorAll('input[name="kit_qtds"]').forEach(x => x.remove());

      document.querySelectorAll(".kit-check").forEach(chk => {
        if (chk.checked) {
          const id = chk.value;
          const qtdInput = document.querySelector(`.kit-qtd[data-id="${id}"]`);
          let qtd = 1;
          let max = 9999;
          if (qtdInput) {
            qtd = parseInt(qtdInput.value || "1");
            max = parseInt(qtdInput.max || max);
            if (isNaN(qtd) || qtd < 1) qtd = 1;
            if (!isNaN(max) && qtd > max) qtd = max;
          }

          const hidId = document.createElement("input");
          hidId.type = "hidden";
          hidId.name = "kit_produtos";
          hidId.value = id;
          form.appendChild(hidId);

          const hidQtd = document.createElement("input");
          hidQtd.type = "hidden";
          hidQtd.name = "kit_qtds";
          hidQtd.value = String(qtd);
          form.appendChild(hidQtd);
        }
      });
    });
  }
});
</script>

{% endblock %}