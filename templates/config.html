{% extends "base.html" %}

{% block title %}Configura√ß√µes - AguaPura{% endblock %}

{% block content %}

<style>
    :root {
        --fundo: #f5f9ff;
        --texto: #222;
        --cinza: #eef3fb;
        --azul: #6ea8fe;
        --card-bg: #ffffff;
        --border: #d0dce9;
        --shadow: rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
        --fundo: #0b1622;
        --texto: #f0f4ff;
        --cinza: #162232;
        --azul: #3b6fb6;
        --card-bg: #1a2838;
        --border: #2a3a52;
        --shadow: rgba(0, 0, 0, 0.4);
    }

    .config-container {
        max-width: 900px;
        margin: 60px auto;
        padding: 0 20px;
    }

    .config-header {
        text-align: center;
        margin-bottom: 50px;
    }

    .config-header h1 {
        color: var(--texto);
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .config-header p {
        color: var(--texto);
        opacity: 0.7;
        font-size: 1.1em;
    }

    .config-sections {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    .config-section {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 35px;
        box-shadow: 0 4px 15px var(--shadow);
        border: 2px solid var(--border);
    }

    .section-title {
        color: var(--texto);
        font-size: 1.5em;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border);
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        color: var(--texto);
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1em;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid var(--border);
        border-radius: 10px;
        background: var(--cinza);
        color: var(--texto);
        font-size: 1em;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--azul);
        background: var(--card-bg);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .avatar-section {
        display: flex;
        align-items: center;
        gap: 25px;
        margin-bottom: 25px;
    }

    .avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--azul);
        object-fit: cover;
    }

    .avatar-upload {
        flex: 1;
    }

    .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
    }

    .btn-primary {
        background: var(--azul);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px var(--shadow);
    }

    .btn-secondary {
        background: var(--cinza);
        color: var(--texto);
        border: 2px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--card-bg);
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 25px;
    }

    .toggle-setting {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: var(--cinza);
        border-radius: 10px;
        margin-bottom: 15px;
    }

    .toggle-setting:last-child {
        margin-bottom: 0;
    }

    .toggle-info h4 {
        color: var(--texto);
        margin-bottom: 5px;
        font-size: 1.1em;
    }

    .toggle-info p {
        color: var(--texto);
        opacity: 0.7;
        font-size: 0.9em;
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: var(--border);
        border-radius: 30px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .toggle-switch.active {
        background: var(--azul);
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform 0.3s ease;
    }

    .toggle-switch.active::after {
        transform: translateX(30px);
    }

    .danger-zone {
        background: #fff5f5;
        border: 2px solid #ffcccc;
    }

    [data-theme="dark"] .danger-zone {
        background: #2a1a1a;
        border-color: #5a3a3a;
    }

    .danger-zone .section-title {
        color: #dc3545;
        border-bottom-color: #ffcccc;
    }

    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 0.95em;
    }

    .alert-success {
        background: #d1e7dd;
        color: #0f5132;
        border: 2px solid #badbcc;
    }

    .alert-error {
        background: #f8d7da;
        color: #842029;
        border: 2px solid #f5c2c7;
    }

    @media (max-width: 768px) {
        .avatar-section {
            flex-direction: column;
            text-align: center;
        }

        .btn-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>

<div class="config-container">
    <div class="config-header">
        <h1>‚öôÔ∏è Configura√ß√µes da Conta</h1>
        <p>Gerencie suas informa√ß√µes e prefer√™ncias</p>
    </div>

    {% with msgs = get_flashed_messages(with_categories=True) %}
    {% if msgs %}
        {% for categoria, texto in msgs %}
        <div class="alert alert-{{ 'success' if categoria == 'sucesso' else 'error' }}">
            {{ texto }}
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="config-sections">

        <!-- DADOS PESSOAIS -->
        <div class="config-section">
            <h3 class="section-title">
                <span>üë§</span>
                Informa√ß√µes Pessoais
            </h3>

            <form method="POST" action="/config/atualizar-perfil" enctype="multipart/form-data">
                <div class="avatar-section">
                    <img src="{{ usuario_avatar }}" 
                    class="avatar-preview" 
                    id="avatarPreview">
                    <div class="avatar-upload">
                        <label>Foto de Perfil</label>
                        <input type="file" 
                               name="avatar" 
                               accept="image/*" 
                               id="avatarInput"
                               style="margin-top: 10px;">
                    </div>
                </div>

                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" 
                           name="nome" 
                           value="{{ session.get('usuario_nome', '') }}" 
                           required>
                </div>

                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" 
                           name="email" 
                           value="{{ session.get('usuario_email', '') }}" 
                           required>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                    <button type="reset" class="btn btn-secondary">üîÑ Cancelar</button>
                </div>
            </form>
        </div>

        <!-- SEGURAN√áA -->
        <div class="config-section">
            <h3 class="section-title">
                <span>üîí</span>
                Seguran√ßa
            </h3>

            <form method="POST" action="/config/alterar-senha">
                <div class="form-group">
                    <label>Senha Atual</label>
                    <input type="password" name="senha_atual" required>
                </div>

                <div class="form-group">
                    <label>Nova Senha</label>
                    <input type="password" name="nova_senha" required minlength="6">
                </div>

                <div class="form-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" name="confirmar_senha" required minlength="6">
                </div>

                <button type="submit" class="btn btn-primary">üîê Alterar Senha</button>
            </form>
        </div>



        <!-- PREFER√äNCIAS -->
        <div class="config-section">
            <h3 class="section-title">
                <span>üîî</span>
                Prefer√™ncias
            </h3>

         
            <!-- Adicione/garanta isto em Prefer√™ncias -->
                <div class="toggle-setting">
                    <div class="toggle-info">
                    <h4>Modo Escuro</h4>
                    <p>Altere entre tema claro e escuro</p>
                    </div>
                    <!-- id opcional: o script aceita id ou data-purpose -->
                    <div class="toggle-switch" id="theme-toggle" data-purpose="theme"></div>
                </div>
  
            

           

        <!-- ZONA DE PERIGO -->
        <div class="config-section danger-zone">
            <h3 class="section-title">
                <span>‚ö†Ô∏è</span>
                Zona de Perigo
            </h3>

            <p style="color: var(--texto); margin-bottom: 20px;">
                Essas a√ß√µes s√£o irrevers√≠veis. Tenha certeza antes de continuar.
            </p>

            <div class="btn-group">
                <button class="btn btn-danger" onclick="confirmarExclusao()">
                    üóëÔ∏è Excluir Conta
                </button>
            </div>
        </div>

    </div>
</div>

<script>
// Preview de Avatar
document.getElementById('avatarInput')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Toggle Switch
function toggleSwitch(element) {
    element.classList.toggle('active');
    // Aqui voc√™ pode fazer uma requisi√ß√£o AJAX para salvar a prefer√™ncia
}

// Buscar CEP (ViaCEP API)
document.getElementById('cep')?.addEventListener('blur', function() {
    const cep = this.value.replace(/\D/g, '');
    
    if (cep.length === 8) {
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(res => res.json())
            .then(data => {
                if (!data.erro) {
                    document.getElementById('rua').value = data.logradouro || '';
                    document.getElementById('bairro').value = data.bairro || '';
                    document.getElementById('cidade').value = data.localidade || '';
                    document.getElementById('estado').value = data.uf || '';
                }
            })
            .catch(err => console.error('Erro ao buscar CEP:', err));
    }
});

// Confirmar exclus√£o
function confirmarExclusao() {
    if (confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ tem certeza que deseja excluir sua conta?\n\nEsta a√ß√£o N√ÉO pode ser desfeita e voc√™ perder√°:\n‚Ä¢ Hist√≥rico de pedidos\n‚Ä¢ Favoritos\n‚Ä¢ Dados salvos\n\nDeseja continuar?')) {
        if (confirm('Digite "CONFIRMAR" para excluir permanentemente')) {
            window.location.href = '/config/excluir-conta';
        }
    }
}

// M√°scara de CEP
document.getElementById('cep')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 5) {
        value = value.slice(0, 5) + '-' + value.slice(5, 8);
    }
    e.target.value = value;
});

(function() {
  const STORAGE_KEY = 'theme';
  const root = document.documentElement;
  const logo = document.getElementById('site-logo');

  function safeSetStorage(key, value) {
    try { localStorage.setItem(key, value); } catch(e) {}
  }
  function safeGetStorage(key) {
    try { return localStorage.getItem(key); } catch(e) { return null; }
  }

  function applyTheme(theme) {
    if (!theme) theme = 'light';
    root.setAttribute('data-theme', theme);
    safeSetStorage(STORAGE_KEY, theme);

    if (logo && logo.dataset) {
      // troca suave do logo se presente
      logo.style.transition = 'opacity 0.25s ease';
      logo.style.opacity = '0';
      setTimeout(() => {
        if (logo.dataset.dark && logo.dataset.light) {
          logo.src = (theme === 'dark') ? logo.dataset.dark : logo.dataset.light;
        }
        logo.style.opacity = '1';
      }, 150);
    }
  }

  // l√™ tema salvo (fallback 'light')
  const initialSaved = safeGetStorage(STORAGE_KEY) || 'light';
  applyTheme(initialSaved);

  // fun√ß√£o que aplica visual do toggle (ativa/desativa)
  function setToggleVisual(el, theme) {
    if (!el) return;
    if (theme === 'dark') el.classList.add('active');
    else el.classList.remove('active');
  }

  // fun√ß√£o para ligar/desligar tema a partir do elemento
  function toggleFromElement(el) {
    if (!el) return;
    // se existir fun√ß√£o global toggleSwitch (a sua), tenta reutilizar para manter comportamento/AJAX
    if (typeof window.toggleSwitch === 'function') {
      try {
        window.toggleSwitch(el);
      } catch (err) {
        el.classList.toggle('active');
      }
    } else {
      el.classList.toggle('active');
    }
    const newTheme = el.classList.contains('active') ? 'dark' : 'light';
    applyTheme(newTheme);
  }

  // encontra o elemento de toggle: por id, por data-purpose ou por classe espec√≠fica (fallback)
  function findThemeToggle() {
    return document.getElementById('theme-toggle') ||
           document.querySelector('.toggle-switch[data-purpose="theme"]') ||
           Array.from(document.querySelectorAll('.toggle-switch')).find(e => e.closest('.toggle-setting') && e.previousElementSibling?.querySelector('h4')?.textContent?.trim().toLowerCase().includes('modo escuro'));
  }

  // anexa o listener se o elemento existir
  function attachOnce() {
    const el = findThemeToggle();
    if (!el) return false;

    // evita anexar m√∫ltiplos listeners
    if (el.__theme_attached) return true;
    el.__theme_attached = true;

    // atualiza visual conforme tema atual
    const current = safeGetStorage(STORAGE_KEY) || 'light';
    setToggleVisual(el, current);

    // clique
    el.addEventListener('click', (ev) => {
      ev.preventDefault();
      toggleFromElement(el);
    });

    // acessibilidade: permite usar Enter/Space
    el.setAttribute('role', 'button');
    el.setAttribute('tabindex', '0');
    el.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault();
        toggleFromElement(el);
      }
    });

    return true;
  }

  // tenta anexar imediatamente no DOMContentLoaded
  document.addEventListener('DOMContentLoaded', () => {
    if (!attachOnce()) {
      // se n√£o encontrou, observa o DOM por altera√ß√µes e anexa quando aparecer
      const mo = new MutationObserver((mutations, observer) => {
        if (attachOnce()) {
          observer.disconnect();
        }
      });
      mo.observe(document.body || document.documentElement, { childList: true, subtree: true });
      // timeout de seguran√ßa: depois de 6s desliga observer
      setTimeout(() => mo.disconnect(), 6000);
    }
  });

})();

</script>

{% endblock %}