{% extends "base.html" %}
{% block content %}

<style>
:root{--fundo:#f5f9ff;--texto:#222;--cinza:#eef3fb;--azul:#007bff;--card-bg:#ffffff;--border:#d0dce9;--shadow:rgba(0,0,0,0.1);}
[data-theme="dark"]{--fundo:#0b1622;--texto:#f0f4ff;--cinza:#162232;--azul:#0d6efd;--card-bg:#1a2838;--border:#2a3a52;--shadow:rgba(0,0,0,0.4);}
.perfil-container{display:flex;max-width:1400px;margin:60px auto;gap:30px;padding:0 20px;}
.perfil-sidebar{width:280px;background:var(--card-bg);border-radius:16px;padding:30px;box-shadow:0 4px 12px var(--shadow);height:fit-content;position:sticky;top:100px;}
.perfil-user{text-align:center;margin-bottom:30px;}
.perfil-avatar{width:100px;height:100px;border-radius:50%;border:4px solid var(--azul);margin-bottom:15px;object-fit:cover;}
.perfil-user h3{color:var(--texto);font-size:1.3em;margin:0;}
.perfil-menu{display:flex;flex-direction:column;gap:10px;}
.perfil-tab{background:transparent;border:2px solid var(--border);color:var(--texto);padding:14px 20px;border-radius:10px;cursor:pointer;font-size:1em;font-weight:500;transition:all 0.3s ease;text-align:left;}
.perfil-tab:hover{background:var(--cinza);border-color:var(--azul);}
.perfil-tab.active{background:var(--azul);color:white;border-color:var(--azul);}
.perfil-content{flex:1;background:var(--card-bg);border-radius:16px;padding:40px;box-shadow:0 4px 12px var(--shadow);min-height:600px;}
.tab-content{display:none;}
.tab-content.active{display:block;animation:fadeIn 0.4s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
.field{margin-bottom:16px;}
label{display:block;font-weight:600;margin-bottom:8px;color:var(--texto);}
input[type="text"],input[type="email"],input[type="tel"],textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--card-bg);color:var(--texto);font-size:0.95rem;transition:border 0.2s;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--azul);}
.card-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px;}
.card-item{background:var(--cinza);padding:18px;border-radius:12px;border:1px solid var(--border);position:relative;transition:transform 0.2s;}
.card-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px var(--shadow);}
.small-btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.2s;}
.btn-danger{background:#dc3545;color:white;}
.btn-danger:hover{background:#c82333;}
.btn-primary{background:linear-gradient(135deg,#007bff 0%,#0056b3 100%);color:white;padding:14px 28px;border-radius:10px;border:none;cursor:pointer;font-size:1rem;font-weight:700;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,123,255,0.3);margin-top:12px;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,123,255,0.4);}
.btn-primary:active{transform:translateY(0);}
.helper{font-size:0.9rem;color:var(--texto);opacity:0.7;margin-top:4px;}
hr{border:none;border-top:1px solid var(--border);margin:24px 0;}
.historico-table{width:100%;border-collapse:collapse;margin-top:20px;}
.historico-table thead tr{background:var(--azul);color:white;}
.historico-table th{padding:14px;text-align:left;font-weight:600;}
.historico-table tbody tr{background:var(--cinza);border-bottom:1px solid var(--border);}
.historico-table td{padding:14px;}
.status-badge{display:inline-block;padding:6px 14px;border-radius:20px;font-size:0.85rem;font-weight:600;}
.status-aguardando-pagamento{background:#ffc107;color:#000;}
.status-pago{background:#28a745;color:white;}
.status-enviado{background:#17a2b8;color:white;}
.status-entregue{background:#6c757d;color:white;}
.sem-dados{text-align:center;padding:40px 20px;color:var(--texto);opacity:0.7;}
.sem-dados-icon{font-size:3rem;margin-bottom:16px;}
.chart-wrapper{margin:24px 0;padding:20px;background:var(--cinza);border-radius:12px;overflow-x:auto;}
.grafico-barras{display:flex;align-items:flex-end;gap:16px;min-height:300px;padding:20px 0;}
.barra-item{flex:1;display:flex;flex-direction:column;align-items:center;min-width:60px;}
.barra{width:100%;background:linear-gradient(180deg,var(--azul) 0%,#0056b3 100%);border-radius:8px 8px 0 0;position:relative;transition:all 0.3s;display:flex;align-items:flex-start;justify-content:center;padding-top:8px;}
.barra:hover{opacity:0.8;transform:translateY(-4px);}
.barra-valor{color:white;font-weight:700;font-size:0.9rem;}
.barra-mes{margin-top:8px;font-size:0.85rem;color:var(--texto);font-weight:600;}
.stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:24px;}
.stat-card{background:var(--cinza);padding:20px;border-radius:12px;text-align:center;border:1px solid var(--border);transition:transform 0.2s;}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px var(--shadow);}
.stat-card-icon{font-size:2.5rem;margin-bottom:12px;}
.stat-card-valor{font-size:2rem;font-weight:700;color:var(--azul);margin-bottom:8px;}
.stat-card-label{font-size:0.9rem;color:var(--texto);opacity:0.8;}
.favoritos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:20px;}
.produto-card{background:var(--cinza);border-radius:12px;overflow:hidden;border:1px solid var(--border);transition:transform 0.2s;}
.produto-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px var(--shadow);}
.produto-card img{width:100%;height:180px;object-fit:cover;}
.produto-info{padding:16px;}
.produto-card h3{font-size:1rem;margin:0 0 8px 0;color:var(--texto);}
.produto-card .preco{font-size:1.2rem;font-weight:700;color:var(--azul);margin:0;}
.loading{text-align:center;padding:40px;color:var(--texto);opacity:0.7;}
@media (max-width:968px){.perfil-container{flex-direction:column;}.perfil-sidebar{width:100%;position:static;}.form-row{grid-template-columns:1fr;}}
</style>

<div class="perfil-container">
  <aside class="perfil-sidebar">
    <div class="perfil-user">
      <img src="{{ usuario.avatar}}" alt="Avatar" class="perfil-avatar">
      <h3>{{ usuario.nome }}</h3>
    </div>
    <nav class="perfil-menu">
      <button class="perfil-tab active" data-tab="geral">üìä Vis√£o Geral</button>
      <button class="perfil-tab" data-tab="favoritos">‚ù§Ô∏è Favoritos</button>
      <button class="perfil-tab" data-tab="historico">üìã Hist√≥rico</button>
      <button class="perfil-tab" data-tab="enderecos">üìç Endere√ßos</button>
      <button class="perfil-tab" data-tab="pagamentos">üí≥ Pagamentos</button>
      <button class="perfil-tab" data-tab="estatisticas">üìà Estat√≠sticas</button>
    </nav>
  </aside>

  <section class="perfil-content">
    <div id="geral" class="tab-content active">
      <h2>üëã Ol√°, {{ usuario.nome }}!</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-top:24px">
        <div style="background:var(--azul);padding:24px;border-radius:12px;color:white"><div style="font-size:2rem;font-weight:700">{{ pedidos|length }}</div><div style="opacity:0.9;margin-top:8px">Total de Pedidos</div></div>
        <div style="background:var(--azul);padding:24px;border-radius:12px;color:white"><div style="font-size:2rem;font-weight:700">{{ favoritos|length }}</div><div style="opacity:0.9;margin-top:8px">Favoritos</div></div>
        <div style="background:var(--azul);padding:24px;border-radius:12px;color:white"><div style="font-size:1.3rem;font-weight:700">{{ usuario.criado_em.strftime('%d/%m/%Y') }}</div><div style="opacity:0.9;margin-top:8px">Membro desde</div></div>
      </div>
    </div>

    <div id="favoritos" class="tab-content"><h2>‚ù§Ô∏è Meus Favoritos</h2><div id="favoritosContent" class="loading">Carregando favoritos...</div></div>

    <div id="historico" class="tab-content"><h2>üìã Hist√≥rico de Compras</h2><table class="historico-table"><thead><tr><th>ID</th><th>Data</th><th>Status</th><th>Valor Total</th><th>M√©todo</th></tr></thead><tbody>{% for p in pedidos %}<tr><td>#{{ p.id }}</td><td>{{ p.criado_em.strftime('%d/%m/%Y') }}</td><td><span class="status-badge status-{{ p.status|lower|replace(' ','-') }}">{{ p.status }}</span></td><td>R$ {{ '%.2f'|format(p.valor_total) }}</td><td>{{ p.pagamento_metodo or 'N/A' }}</td></tr>{% else %}<tr><td colspan="5" style="text-align:center;padding:40px"><div class="sem-dados"><div class="sem-dados-icon">üì¶</div><p>Nenhum pedido encontrado</p></div></td></tr>{% endfor %}</tbody></table></div>

    <div id="enderecos" class="tab-content"><h2>üìç Meus Endere√ßos</h2><div class="card-list">{% for e in enderecos %}<div class="card-item"><div style="font-weight:700;font-size:1.1rem;margin-bottom:8px">{{ e.nome_destinatario }}</div><div class="helper">CPF: {{ e.cpf }}</div><div style="margin-top:10px;line-height:1.6">{{ e.rua }}, {{ e.numero }}{% if e.bairro %} - {{ e.bairro }}{% endif %}</div><div class="helper">{{ e.cidade }}/{{ e.estado }} ‚Ä¢ CEP {{ e.cep }}</div><form method="POST" action="{{ url_for('excluir_endereco',endereco_id=e.id) }}" style="position:absolute;right:14px;top:14px"><button type="submit" class="small-btn btn-danger">Excluir</button></form></div>{% else %}<div class="sem-dados" style="padding:18px;grid-column:1/-1"><div class="sem-dados-icon">üìç</div><p>Nenhum endere√ßo salvo ainda.</p></div>{% endfor %}</div><hr><h3 style="margin-bottom:20px">Adicionar novo endere√ßo</h3><form method="POST" action="{{ url_for('salvar_endereco') }}" id="formEndereco" style="max-width:800px"><div class="form-row"><div class="field"><label>Nome do destinat√°rio *</label><input type="text" name="nome_destinatario" required></div><div class="field"><label>CPF *</label><input type="text" id="cpfInput" name="cpf" required placeholder="000.000.000-00"></div></div><div class="field"><label>CEP *</label><input type="text" id="cepEndereco" name="cep" required placeholder="00000-000"></div><div class="field"><label>Rua *</label><input type="text" id="ruaEndereco" name="rua" required></div><div class="form-row"><div class="field"><label>N√∫mero *</label><input type="text" name="numero" required></div><div class="field"><label>Complemento / Bairro</label><input type="text" name="bairro" id="bairroEndereco" placeholder="Opcional"></div></div><div class="form-row"><div class="field"><label>Estado *</label><select id="estadoSelect" name="estado" required><option value="">Selecione...</option></select></div><div class="field"><label>Cidade *</label><select id="cidadeSelect" name="cidade" required><option value="">Selecione o estado primeiro</option></select></div></div><button type="submit" class="btn-primary">Salvar endere√ßo</button></form></div>

    <div id="pagamentos" class="tab-content"><h2>üí≥ M√©todos de Pagamento</h2><div class="card-list">{% for p in pagamentos %}<div class="card-item">{% if p.tipo=='PIX' %}<div style="font-weight:700;font-size:1.1rem;margin-bottom:8px">üî∑ PIX</div><div class="helper">Chave: {{ p.chave_pix }}</div>{% else %}<div style="font-weight:700;font-size:1.1rem;margin-bottom:8px">üí≥ Cart√£o de Cr√©dito</div><div style="margin-top:8px">{{ p.nome_impresso or '-' }}</div><div style="margin-top:8px;font-family:monospace">{{ p.numero_mascarado }}</div><div class="helper">Validade: {{ p.validade }}</div>{% endif %}<form method="POST" action="{{ url_for('excluir_pagamento',pid=p.id) }}" style="position:absolute;right:14px;top:14px"><button type="submit" class="small-btn btn-danger">Excluir</button></form></div>{% else %}<div class="sem-dados" style="padding:18px;grid-column:1/-1"><div class="sem-dados-icon">üí≥</div><p>Nenhum m√©todo salvo.</p></div>{% endfor %}</div><hr><h3 style="margin-bottom:20px">Adicionar novo cart√£o de cr√©dito</h3><form id="formPagamento" method="POST" action="{{ url_for('salvar_pagamento') }}" style="max-width:600px"><input type="hidden" name="tipo" value="CARTAO"><div class="field"><label>Nome impresso no cart√£o *</label><input type="text" name="nome_impresso" required placeholder="NOME DO TITULAR"></div><div class="field"><label>N√∫mero do cart√£o *</label><input type="text" id="cardNumber" name="numero" required placeholder="0000 0000 0000 0000" maxlength="19"></div><div class="form-row"><div class="field"><label>Validade *</label><input type="text" id="cardVal" name="validade" required placeholder="MM/AA" maxlength="5"></div><div class="field"><label>CVV *</label><input type="text" id="cardCvv" name="cvv" required placeholder="123" maxlength="4"></div></div><div class="helper" style="margin-bottom:16px">üîí O n√∫mero do cart√£o √© armazenado de forma segura (apenas os 4 √∫ltimos d√≠gitos s√£o vis√≠veis).</div><button type="submit" class="btn-primary">Salvar cart√£o</button></form></div>

    <div id="estatisticas" class="tab-content"><h2>üìà Estat√≠sticas</h2><div id="statsLoading" class="loading">Carregando estat√≠sticas...</div><div id="statsContent" style="display:none"><div class="chart-wrapper"><div class="grafico-barras" id="graficoBarras"></div></div><div class="stats-cards" id="statsCards"></div></div><div id="semDadosStats" class="sem-dados" style="display:none"><div class="sem-dados-icon">üìä</div><h3>Nenhuma estat√≠stica dispon√≠vel</h3><p>Realize compras para ver seus dados</p></div></div>
  </section>
</div>

<script>
const tabs=document.querySelectorAll(".perfil-tab");const conteudos=document.querySelectorAll(".tab-content");tabs.forEach(tab=>{tab.addEventListener("click",()=>{tabs.forEach(t=>t.classList.remove("active"));tab.classList.add("active");conteudos.forEach(c=>c.classList.remove("active"));document.getElementById(tab.dataset.tab).classList.add("active");window.scrollTo({top:0,behavior:'smooth'});});});
const favoritosContent=document.getElementById('favoritosContent');fetch('/api/favoritos').then(res=>res.json()).then(favoritos=>{if(!favoritos||favoritos.length===0){favoritosContent.innerHTML='<div class="sem-dados"><div class="sem-dados-icon">‚ù§Ô∏è</div><h3>Nenhum favorito ainda</h3><p>Adicione produtos aos seus favoritos para v√™-los aqui</p></div>';return;}favoritosContent.className='favoritos-grid';favoritosContent.innerHTML=favoritos.map(fav=>`<div class="produto-card"><img src="${fav.imagem_principal}" alt="${fav.nome}"><div class="produto-info"><h3>${fav.nome}</h3><p class="preco">R$ ${parseFloat(fav.preco).toFixed(2)}</p></div></div>`).join('');}).catch(()=>{favoritosContent.innerHTML='<div class="sem-dados">Erro ao carregar favoritos</div>';});
async function carregarEstados(){const ufSelect=document.getElementById('estadoSelect');const cidadeSelect=document.getElementById('cidadeSelect');if(!ufSelect)return;ufSelect.innerHTML='<option value="">Carregando...</option>';try{const res=await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome');const estados=await res.json();ufSelect.innerHTML='<option value="">Selecione o estado</option>';estados.forEach(e=>{const opt=document.createElement('option');opt.value=e.sigla;opt.textContent=e.nome+' ('+e.sigla+')';ufSelect.appendChild(opt);});}catch(err){ufSelect.innerHTML='<option value="">Erro ao carregar</option>';}ufSelect.addEventListener('change',async()=>{const uf=ufSelect.value;cidadeSelect.innerHTML='<option>Carregando...</option>';if(!uf){cidadeSelect.innerHTML='<option value="">Selecione o estado primeiro</option>';return;}try{const r2=await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios?orderBy=nome`);const cidades=await r2.json();cidadeSelect.innerHTML='<option value="">Selecione a cidade</option>';cidades.forEach(c=>{const o=document.createElement('option');o.value=c.nome;o.textContent=c.nome;cidadeSelect.appendChild(o);});}catch(err){cidadeSelect.innerHTML='<option value="">Erro ao carregar cidades</option>';}});}carregarEstados();
const cepInput=document.getElementById('cepEndereco');if(cepInput){cepInput.addEventListener('blur',function(){const v=this.value.replace(/\D/g,'');if(v.length!==8)return;fetch(`https://viacep.com.br/ws/${v}/json/`).then(res=>res.json()).then(data=>{if(!data.erro){document.getElementById('ruaEndereco').value=data.logradouro||'';document.getElementById('bairroEndereco').value=data.bairro||'';if(data.uf){const est=document.getElementById('estadoSelect');if(est){est.value=data.uf;est.dispatchEvent(new Event('change'));setTimeout(()=>{const cidadeSel=document.getElementById('cidadeSelect');if(cidadeSel&&data.localidade){for(let i=0;i<cidadeSel.options.length;i++){if(cidadeSel.options[i].value.toLowerCase()===data.localidade.toLowerCase()){cidadeSel.selectedIndex=i;break;}}}},600);}}}}).catch(()=>{});});}
function mask(o,f){setTimeout(()=>{o.value=f(o.value);},1);}function cpfMask(v){v=v.replace(/\D/g,'').slice(0,11);v=v.replace(/(\d{3})(\d)/,'$1.$2');v=v.replace(/(\d{3})(\d)/,'$1.$2');v=v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');return v;}function cepMask(v){v=v.replace(/\D/g,'').slice(0,8);if(v.length>5)return v.slice(0,5)+'-'+v.slice(5);return v;}function cardMask(v){v=v.replace(/\D/g,'').slice(0,16);return v.replace(/(\d{4})/g,'$1 ').trim();}function validadeMask(v){v=v.replace(/\D/g,'').slice(0,4);if(v.length>2)return v.slice(0,2)+'/'+v.slice(2);return v;}
const cpfEl=document.getElementById('cpfInput');const cepEl=document.getElementById('cepEndereco');const cardEl=document.getElementById('cardNumber');const valEl=document.getElementById('cardVal');if(cpfEl)cpfEl.addEventListener('input',e=>mask(e.target,cpfMask));if(cepEl)cepEl.addEventListener('input',e=>mask(e.target,cepMask));if(cardEl)cardEl.addEventListener('input',e=>mask(e.target,cardMask));if(valEl)valEl.addEventListener('input',e=>mask(e.target,validadeMask));
const statsLoading=document.getElementById('statsLoading');const statsContent=document.getElementById('statsContent');const semDadosStats=document.getElementById('semDadosStats');const graficoBarras=document.getElementById('graficoBarras');const statsCards=document.getElementById('statsCards');const meses={1:'Jan',2:'Fev',3:'Mar',4:'Abr',5:'Mai',6:'Jun',7:'Jul',8:'Ago',9:'Set',10:'Out',11:'Nov',12:'Dez'};fetch('/api/estatisticas').then(r=>r.json()).then(dados=>{statsLoading.style.display='none';if(!dados||dados.length===0){semDadosStats.style.display='block';return;}statsContent.style.display='block';const maxTotal=Math.max(...dados.map(d=>d.total));const alturaMax=280;dados.forEach(item=>{const altura=Math.max((item.total/maxTotal)*alturaMax,30);const barraItem=document.createElement('div');barraItem.className='barra-item';barraItem.innerHTML=`<div class="barra" style="height:${altura}px"><span class="barra-valor">${item.total}</span></div><div class="barra-mes">${meses[item.mes]}</div>`;graficoBarras.appendChild(barraItem);});const totalPedidos=dados.reduce((s,d)=>s+d.total,0);const media=(totalPedidos/dados.length).toFixed(1);const melhorMes=dados.reduce((max,d)=>d.total>max.total?d:max);statsCards.innerHTML=`<div class="stat-card"><div class="stat-card-icon">üì¶</div><div class="stat-card-valor">${totalPedidos}</div><div class="stat-card-label">Total de Pedidos</div></div><div class="stat-card"><div class="stat-card-icon">üìä</div><div class="stat-card-valor">${media}</div><div class="stat-card-label">M√©dia Mensal</div></div><div class="stat-card"><div class="stat-card-icon">üèÜ</div><div class="stat-card-valor">${melhorMes.total}</div><div class="stat-card-label">Melhor M√™s (${meses[melhorMes.mes]})</div></div><div class="stat-card"><div class="stat-card-icon">üìÖ</div><div class="stat-card-valor">${dados.length}</div><div class="stat-card-label">Meses Ativos</div></div>`;}).catch(()=>{statsLoading.style.display='none';semDadosStats.style.display='block';});
</script>

{% endblock %}