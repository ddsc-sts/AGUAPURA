{% extends "base.html" %}
{% block content %}

<style>
/* seu CSS mantido (reduzi apenas a repeti√ß√£o m√≠nima) */
:root { --fundo:#f5f9ff; --texto:#222; --cinza:#eef3fb; --azul:#6ea8fe; --card-bg:#ffffff; --border:#d0dce9; --shadow:rgba(0,0,0,0.1); }
[data-theme="dark"] { --fundo:#0b1622; --texto:#f0f4ff; --cinza:#162232; --azul:#3b6fb6; --card-bg:#1a2838; --border:#2a3a52; --shadow:rgba(0,0,0,0.4); }

.perfil-container{display:flex;max-width:1400px;margin:60px auto;gap:30px;padding:0 20px;}
.perfil-sidebar{width:280px;background:var(--card-bg);border-radius:16px;padding:30px;box-shadow:0 4px 12px var(--shadow);height:fit-content;position:sticky;top:100px;}
.perfil-user{text-align:center;margin-bottom:30px;}
.perfil-avatar{width:100px;height:100px;border-radius:50%;border:4px solid var(--azul);margin-bottom:15px;object-fit:cover;}
.perfil-user h3{color:var(--texto);font-size:1.3em;margin:0;}
.perfil-menu{display:flex;flex-direction:column;gap:10px;}
.perfil-tab{background:transparent;border:2px solid var(--border);color:var(--texto);padding:14px 20px;border-radius:10px;cursor:pointer;font-size:1em;font-weight:500;transition:all 0.3s ease;text-align:left;}
.perfil-tab:hover{background:var(--cinza);border-color:var(--azul);}
.perfil-tab.active{background:var(--azul);color:white;border-color:var(--azul);}
.perfil-content{flex:1;background:var(--card-bg);border-radius:16px;padding:40px;box-shadow:0 4px 12px var(--shadow);min-height:600px;}
.tab-content{display:none;}
.tab-content.active{display:block;animation:fadeIn 0.4s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
/* pequenas classes para forms */
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
.field{margin-bottom:12px;}
label{display:block;font-weight:600;margin-bottom:6px;color:var(--texto);}
input[type="text"], input[type="email"], input[type="tel"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--card-bg);color:var(--texto);}
.card-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px;}
.card-item{background:var(--cinza);padding:14px;border-radius:10px;border:1px solid var(--border);position:relative;}
.small-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
.btn-danger{background:#dc3545;color:white;}
.btn-primary{background:var(--azul);color:white;}
.helper{font-size:0.9rem;color:var(--texto);opacity:0.8;}
hr{border:none;border-top:1px solid var(--border);margin:18px 0;}
</style>

<div class="perfil-container">
  <!-- Sidebar -->
  <aside class="perfil-sidebar">
    <div class="perfil-user">
      <img src="{{ usuario.avatar or usuario_avatar }}" alt="Avatar" class="perfil-avatar">
      <h3>{{ usuario.nome }}</h3>
    </div>

    <nav class="perfil-menu">
      <button class="perfil-tab active" data-tab="geral">üìä Vis√£o Geral</button>
      <button class="perfil-tab" data-tab="favoritos">‚ù§Ô∏è Favoritos</button>
      <button class="perfil-tab" data-tab="historico">üìã Hist√≥rico</button>
      <button class="perfil-tab" data-tab="enderecos">üìç Endere√ßos</button>
      <button class="perfil-tab" data-tab="pagamentos">üí≥ Pagamentos</button>
      <button class="perfil-tab" data-tab="estatisticas">üìà Estat√≠sticas</button>
    </nav>
  </aside>

  <!-- Conte√∫do -->
  <section class="perfil-content">

    <!-- VIS√ÉO GERAL -->
    <div id="geral" class="tab-content active">
      <h2>üëã Ol√°, {{ usuario.nome }}!</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px">
        <div style="background:var(--azul);padding:18px;border-radius:12px;color:white;">
          <div style="font-size:1.3rem;font-weight:700">{{ pedidos|length }}</div>
          <div style="opacity:0.9">Total de Pedidos</div>
        </div>
        <div style="background:var(--azul);padding:18px;border-radius:12px;color:white;">
          <div style="font-size:1.3rem;font-weight:700">{{ favoritos|length }}</div>
          <div style="opacity:0.9">Favoritos</div>
        </div>
        <div style="background:var(--azul);padding:18px;border-radius:12px;color:white;">
          <div style="font-size:1.3rem;font-weight:700">{{ usuario.criado_em.strftime('%d/%m/%Y') }}</div>
          <div style="opacity:0.9">Membro desde</div>
        </div>
      </div>
    </div>

    <!-- FAVORITOS -->
    <div id="favoritos" class="tab-content">
      <h2>‚ù§Ô∏è Meus Favoritos</h2>
      <div id="favoritosContent" class="helper">Carregando favoritos...</div>
    </div>

    <!-- HIST√ìRICO -->
    <div id="historico" class="tab-content">
      <h2>üìã Hist√≥rico de Compras</h2>
      <table class="historico-table" style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="background:var(--azul);color:white;">
            <th style="padding:12px;text-align:left">ID</th>
            <th style="padding:12px;text-align:left">Data</th>
            <th style="padding:12px;text-align:left">Status</th>
            <th style="padding:12px;text-align:left">Valor Total</th>
            <th style="padding:12px;text-align:left">M√©todo</th>
          </tr>
        </thead>
        <tbody>
        {% for p in pedidos %}
          <tr style="background:var(--cinza);">
            <td style="padding:12px">#{{ p.id }}</td>
            <td style="padding:12px">{{ p.criado_em.strftime('%d/%m/%Y') }}</td>
            <td style="padding:12px">
              <span style="display:inline-block;padding:6px 12px;border-radius:16px;"
                    class="status-badge status-{{ p.status|lower|replace(' ', '-') }}">
                {{ p.status }}
              </span>
            </td>
            <td style="padding:12px">R$ {{ '%.2f'|format(p.valor_total) }}</td>
            <td style="padding:12px">{{ p.pagamento_metodo or 'N/A' }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" style="text-align:center;padding:40px;">
              <div class="sem-dados-icon">üì¶</div>
              Nenhum pedido encontrado
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ENDERE√áOS -->
    <div id="enderecos" class="tab-content">
      <h2>üìç Meus Endere√ßos</h2>

      <!-- Lista de endere√ßos -->
      <div class="card-list">
        {% for e in enderecos %}
        <div class="card-item">
          <div style="font-weight:700">{{ e.nome_destinatario }}</div>
          <div class="helper">CPF: {{ e.cpf }}</div>
          <div style="margin-top:8px">{{ e.rua }}, {{ e.numero }}{% if e.bairro %} - {{ e.bairro }}{% endif %}</div>
          <div class="helper">{{ e.cidade }}/{{ e.estado }} ‚Ä¢ CEP {{ e.cep }}</div>

          <form method="POST" action="{{ url_for('excluir_endereco', endereco_id=e.id) }}" style="position:absolute;right:10px;top:10px;">
            <button type="submit" class="small-btn btn-danger">Excluir</button>
          </form>
        </div>
        {% else %}
        <div class="sem-dados" style="padding:18px">Nenhum endere√ßo salvo ainda.</div>
        {% endfor %}
      </div>

      <hr>

      <!-- Form novo endere√ßo -->
      <h3>Adicionar novo endere√ßo</h3>
      <form method="POST" action="{{ url_for('salvar_endereco') }}" id="formEndereco">
        <div class="form-row">
          <div class="field">
            <label>Nome do destinat√°rio *</label>
            <input type="text" name="nome_destinatario" required>
          </div>
          <div class="field">
            <label>CPF *</label>
            <input type="text" id="cpfInput" name="cpf" required placeholder="000.000.000-00">
          </div>
        </div>

        <div class="field">
          <label>CEP *</label>
          <input type="text" id="cepEndereco" name="cep" required placeholder="00000-000">
        </div>

        <div class="field">
          <label>Rua *</label>
          <input type="text" id="ruaEndereco" name="rua" required>
        </div>

        <div class="form-row">
          <div class="field">
            <label>N√∫mero *</label>
            <input type="text" name="numero" required>
          </div>
          <div class="field">
            <label>Complemento / Bairro</label>
            <input type="text" name="bairro" id="bairroEndereco" placeholder="Opcional">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Estado *</label>
            <select id="estadoSelect" name="estado" required></select>
          </div>
          <div class="field">
            <label>Cidade *</label>
            <select id="cidadeSelect" name="cidade" required></select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <button type="submit" class="btn-primary">Salvar endere√ßo</button>
        </div>
      </form>
    </div>

    <!-- PAGAMENTOS -->
    <div id="pagamentos" class="tab-content">
      <h2>üí≥ M√©todos de Pagamento</h2>

      <!-- Lista pagamentos -->
      <div class="card-list">
        {% for p in pagamentos %}
        <div class="card-item">
          {% if p.tipo == 'PIX' %}
            <div style="font-weight:700">PIX</div>
            <div class="helper">Chave: {{ p.chave_pix }}</div>
          {% else %}
            <div style="font-weight:700">Cart√£o</div>
            <div class="helper">{{ p.nome_impresso or '-' }}</div>
            <div style="margin-top:8px">{{ p.numero_mascarado }} ‚Ä¢ Val: {{ p.validade }}</div>
          {% endif %}

          <form method="POST" action="{{ url_for('excluir_pagamento', pid=p.id) }}" style="position:absolute;right:10px;top:10px;">
            <button type="submit" class="small-btn btn-danger">Excluir</button>
          </form>
        </div>
        {% else %}
        <div class="sem-dados" style="padding:18px">Nenhum m√©todo salvo.</div>
        {% endfor %}
      </div>

      <hr>

      <!-- Form adicionar -->
      <h3>Adicionar novo m√©todo</h3>
      <div style="display:grid;gap:12px;max-width:720px;">
        <div>
          <label><input type="radio" name="tipo" value="PIX" checked> PIX</label>
          <label style="margin-left:12px;"><input type="radio" name="tipo" value="CARTAO"> Cart√£o</label>
        </div>

        <form id="formPagamento" method="POST" action="{{ url_for('salvar_pagamento') }}">
          <input type="hidden" name="tipo" id="metodoTipo" value="PIX">

          <div id="boxPIX">
            <div class="field">
              <label>Chave PIX (email/CPF/celular) *</label>
              <input type="text" name="chave_pix" placeholder="e.g. seu@email.com / 55999998888" >
            </div>
          </div>

          <div id="boxCartao" style="display:none;">
            <div class="field">
              <label>Nome impresso *</label>
              <input type="text" name="nome_impresso">
            </div>
            <div class="field">
              <label>N√∫mero do cart√£o *</label>
              <input type="text" id="cardNumber" name="numero" placeholder="0000 0000 0000 0000">
            </div>
            <div class="form-row">
              <div class="field">
                <label>Validade (MM/AA)</label>
                <input type="text" id="cardVal" name="validade" placeholder="MM/AA">
              </div>
              <div class="field">
                <label>CVV</label>
                <input type="text" id="cardCvv" name="cvv" placeholder="123">
              </div>
            </div>
            <div class="helper">O n√∫mero do cart√£o √© armazenado de forma mascarada (apenas 4 √∫ltimos d√≠gitos).</div>
          </div>

          <div style="margin-top:12px;">
            <button type="submit" class="btn-primary">Salvar m√©todo</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ESTAT√çSTICAS -->
    <div id="estatisticas" class="tab-content">
      <h2>üìà Estat√≠sticas</h2>
      <div id="statsLoading" class="loading">Carregando estat√≠sticas...</div>
      <div id="statsContent" style="display:none;">
        <div class="chart-wrapper"><div class="grafico-barras" id="graficoBarras"></div></div>
        <div class="stats-cards" id="statsCards"></div>
      </div>
      <div id="semDadosStats" class="sem-dados" style="display:none;">
        <div class="sem-dados-icon">üìä</div>
        <h3>Nenhuma estat√≠stica dispon√≠vel</h3>
        <p>Realize compras para ver seus dados</p>
      </div>
    </div>

  </section>
</div>

<script>
// abas
const tabs = document.querySelectorAll(".perfil-tab");
const conteudos = document.querySelectorAll(".tab-content");
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    conteudos.forEach(c => c.classList.remove("active"));
    const alvo = document.getElementById(tab.dataset.tab);
    alvo.classList.add("active");
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

// carregar favoritos via API (mantive seu endpoint)
const favoritosContent = document.getElementById('favoritosContent');
fetch('/api/favoritos')
  .then(res => res.json())
  .then(favoritos => {
    if (!favoritos || favoritos.length === 0) {
      favoritosContent.innerHTML = `<div class="sem-dados"><div class="sem-dados-icon">‚ù§Ô∏è</div><h3>Nenhum favorito ainda</h3><p>Adicione produtos aos seus favoritos</p></div>`;
      return;
    }
    favoritosContent.className = 'favoritos-grid';
    favoritosContent.innerHTML = favoritos.map(fav => `
      <div class="produto-card">
        <img src="${fav.imagem_principal}" alt="${fav.nome}">
        <div class="produto-info">
          <h3>${fav.nome}</h3>
          <p class="preco">R$ ${parseFloat(fav.preco).toFixed(2)}</p>
        </div>
      </div>
    `).join('');
  })
  .catch(_ => favoritosContent.innerHTML = '<div class="sem-dados">Erro ao carregar favoritos</div>');

// === IBGE: carregar estados -> cidades ===
async function carregarEstados() {
  const ufSelect = document.getElementById('estadoSelect');
  const cidadeSelect = document.getElementById('cidadeSelect');
  ufSelect.innerHTML = '<option value="">Carregando...</option>';
  try {
    const res = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome');
    const estados = await res.json();
    ufSelect.innerHTML = '<option value="">Selecione o estado</option>';
    estados.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e.sigla;
      opt.textContent = e.nome + ' (' + e.sigla + ')';
      ufSelect.appendChild(opt);
    });
  } catch (err) {
    ufSelect.innerHTML = '<option value="">Erro carregando</option>';
  }

  ufSelect.addEventListener('change', async () => {
    const uf = ufSelect.value;
    cidadeSelect.innerHTML = '<option>Carregando...</option>';
    if (!uf) { cidadeSelect.innerHTML = '<option value="">Selecione o estado primeiro</option>'; return; }
    try {
      const r2 = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
      const cidades = await r2.json();
      cidadeSelect.innerHTML = '<option value="">Selecione a cidade</option>';
      cidades.forEach(c => {
        const o = document.createElement('option'); o.value = c.nome; o.textContent = c.nome; cidadeSelect.appendChild(o);
      });
    } catch (err) {
      cidadeSelect.innerHTML = '<option value="">Erro carregando cidades</option>';
    }
  });
}
carregarEstados();

// === ViaCEP para preencher rua/bairro automaticamente (no form de endere√ßo) ===
document.getElementById('cepEndereco')?.addEventListener('blur', function(){
  const v = this.value.replace(/\D/g,'');
  if (v.length !== 8) return;
  fetch(`https://viacep.com.br/ws/${v}/json/`)
    .then(res => res.json())
    .then(data => {
      if (!data.erro) {
        document.getElementById('ruaEndereco').value = data.logradouro || '';
        document.getElementById('bairroEndereco').value = data.bairro || '';
        // tenta selecionar cidade/estado (se dispon√≠vel)
        if (data.uf) {
          const est = document.getElementById('estadoSelect');
          if (est) {
            est.value = data.uf;
            est.dispatchEvent(new Event('change'));
            // ap√≥s carregar cidades, tentar selecionar localidade (pequeno delay)
            setTimeout(()=> {
              const cidadeSel = document.getElementById('cidadeSelect');
              if (cidadeSel) {
                for (let i=0;i<cidadeSel.options.length;i++){
                  if (cidadeSel.options[i].value.toLowerCase() === (data.localidade||'').toLowerCase()){
                    cidadeSel.selectedIndex = i; break;
                  }
                }
              }
            }, 600);
          }
        }
      }
    }).catch(()=>{});
});

// === Troca de m√©todo no form Pagamento ===
const tipoRadios = document.querySelectorAll('input[name="tipo"]');
const boxPIX = document.getElementById('boxPIX');
const boxCartao = document.getElementById('boxCartao');
const metodoTipo = document.getElementById('metodoTipo');

tipoRadios.forEach(r => r.addEventListener('change', () => {
  if (r.value === 'PIX' && r.checked) {
    boxPIX.style.display='block'; boxCartao.style.display='none'; metodoTipo.value='PIX';
  } else if (r.value === 'CARTAO' && r.checked) {
    boxPIX.style.display='none'; boxCartao.style.display='block'; metodoTipo.value='CARTAO';
  }
}));

// === M√°scaras simples ===
function mask(o, f) { setTimeout(()=>{ o.value = f(o.value); }, 1); }
function cpfMask(v){ v=v.replace(/\D/g,''); v=v.slice(0,11); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d)/,'$1.$2'); v=v.replace(/(\d{3})(\d{1,2})$/,'$1-$2'); return v; }
function cepMask(v){ v=v.replace(/\D/g,'').slice(0,8); if (v.length>5) return v.slice(0,5)+'-'+v.slice(5); return v; }
function telMask(v){ v=v.replace(/\D/g,'').slice(0,11); if (v.length>6) return '('+v.slice(0,2)+') '+v.slice(2,7)+'-'+v.slice(7); if (v.length>2) return '('+v.slice(0,2)+') '+v.slice(2); return v; }
function cardMask(v){ v=v.replace(/\D/g,'').slice(0,16); return v.replace(/(\d{4})/g,'$1 ').trim(); }
function validadeMask(v){ v=v.replace(/\D/g,'').slice(0,4); if (v.length>2) return v.slice(0,2)+'/'+v.slice(2); return v; }
document.getElementById('cpfInput')?.addEventListener('input', e => mask(e.target, cpfMask));
document.getElementById('cepEndereco')?.addEventListener('input', e => mask(e.target, cepMask));
document.getElementById('cardNumber')?.addEventListener('input', e => mask(e.target, cardMask));
document.getElementById('cardVal')?.addEventListener('input', e => mask(e.target, validadeMask));

// === Estat√≠sticas (mantive seu fetch) ===
const statsLoading = document.getElementById('statsLoading');
const statsContent = document.getElementById('statsContent');
const semDadosStats = document.getElementById('semDadosStats');
const graficoBarras = document.getElementById('graficoBarras');
const statsCards = document.getElementById('statsCards');
const meses = {1:'Jan',2:'Fev',3:'Mar',4:'Abr',5:'Mai',6:'Jun',7:'Jul',8:'Ago',9:'Set',10:'Out',11:'Nov',12:'Dez'};
fetch('/api/estatisticas').then(r=>r.json()).then(dados=>{
  statsLoading.style.display='none';
  if (!dados || dados.length===0){ semDadosStats.style.display='block'; return; }
  statsContent.style.display='block';
  const maxTotal = Math.max(...dados.map(d=>d.total));
  const alturaMax = 280;
  dados.forEach(item=>{
    const altura = Math.max((item.total/maxTotal)*alturaMax,20);
    const barraItem = document.createElement('div'); barraItem.className='barra-item';
    barraItem.innerHTML = `<div class="barra" style="height:${altura}px"><span class="barra-valor">${item.total}</span></div><div class="barra-mes">${meses[item.mes]}</div>`;
    graficoBarras.appendChild(barraItem);
  });
  const totalPedidos = dados.reduce((s,d)=>s+d.total,0);
  const media = (totalPedidos/dados.length).toFixed(1);
  const melhorMes = dados.reduce((max,d)=>d.total>max.total?d:max);
  statsCards.innerHTML = `
    <div class="stat-card"><div class="stat-card-icon">üì¶</div><div class="stat-card-valor">${totalPedidos}</div><div class="stat-card-label">Total de Pedidos</div></div>
    <div class="stat-card"><div class="stat-card-icon">üìä</div><div class="stat-card-valor">${media}</div><div class="stat-card-label">M√©dia Mensal</div></div>
    <div class="stat-card"><div class="stat-card-icon">üèÜ</div><div class="stat-card-valor">${melhorMes.total}</div><div class="stat-card-label">Melhor M√™s (${meses[melhorMes.mes]})</div></div>
    <div class="stat-card"><div class="stat-card-icon">üìÖ</div><div class="stat-card-valor">${dados.length}</div><div class="stat-card-label">Meses Ativos</div></div>
  `;
}).catch(()=>{ statsLoading.style.display='none'; semDadosStats.style.display='block'; });

</script>

{% endblock %}
