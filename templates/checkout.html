{% extends "base.html" %}
{% block title %}Checkout - AGUAPURA{% endblock %}

{% block content %}
<div style="max-width:1000px; margin:36px auto; padding:20px;">
  <h2>Finalizar Pedido</h2>

  <form id="checkoutForm" method="post" action="{{ url_for('checkout') }}">
    <div style="display:flex; gap:24px; flex-wrap:wrap;">
      <!-- LEFT: DADOS DO CLIENTE -->
      <div style="flex:1; min-width:320px;">

        <div class="glass-card" style="padding:18px; border-radius:12px;">
          <label>Nome completo *</label>
          <input name="nome" id="nome" required class="glass-input" value="{{ session.get('usuario_nome','') }}">

          <label>CPF *</label>
          <input name="cpf" id="cpf" required maxlength="14" class="glass-input" placeholder="000.000.000-00">

          <label>E-mail *</label>
          <input name="email" id="email" type="email" required class="glass-input" placeholder="seu@exemplo.com" value="{{ session.get('usuario_email','') }}">

          <label>Telefone</label>
          <input name="telefone" id="telefone" class="glass-input" placeholder="(00) 00000-0000" maxlength="15">

          <hr style="margin:12px 0; border:none; border-top:1px solid var(--border)">

          <h4>Endere√ßo para entrega</h4>

          <!-- Endere√ßos salvos -->
          {% if session.usuario_id and enderecos %}
          <div style="margin-bottom:10px;">
            <strong>Usar endere√ßo salvo</strong>
            <div style="margin-top:8px;">
              {% for e in enderecos %}
              <label class="saved-label" style="display:block; margin-bottom:6px; border:1px solid var(--border); padding:8px; border-radius:8px; cursor:pointer;">
                <input type="radio" name="endereco_selecionado" value="{{ e.id }}" data-rua="{{ e.rua|e }}" data-numero="{{ e.numero|e }}" data-bairro="{{ e.bairro|e }}" data-cidade="{{ e.cidade|e }}" data-estado="{{ e.estado|e }}" data-cep="{{ e.cep|e }}" style="margin-right:8px;" {% if loop.first %}checked{% endif %}>
                <strong>{{ e.nome_destinatario }}</strong> ‚Äî {{ e.rua }}, {{ e.numero }} {% if e.bairro %} - {{ e.bairro }}{% endif %} ‚Äî {{ e.cidade }}/{{ e.estado }} ‚Ä¢ CEP {{ e.cep }}
              </label>
              {% endfor %}
              <label style="display:block; margin-top:6px; cursor:pointer;">
                <input type="radio" name="endereco_selecionado" value="novo" style="margin-right:8px;"> Usar/Inserir novo endere√ßo
              </label>
            </div>
          </div>
          {% endif %}

          <!-- Formul√°rio de endere√ßo -->
          <div id="enderecoFormWrapper">
            <label>Rua *</label>
            <input name="rua" id="rua" class="glass-input" placeholder="Av. Exemplo">

            <div style="display:flex; gap:8px;">
              <div style="flex:1">
                <label>N√∫mero *</label>
                <input name="numero" id="numero" class="glass-input" placeholder="123">
              </div>
              <div style="flex:1">
                <label>Bairro</label>
                <input name="bairro" id="bairro" class="glass-input" placeholder="Centro">
              </div>
            </div>

            <div style="display:flex; gap:8px; margin-top:8px;">
              <div style="flex:1">
                <label>Estado *</label>
                <select name="estado" id="estado" class="glass-input glass-select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div style="flex:2">
                <label>Cidade *</label>
                <select name="cidade" id="cidade" class="glass-input glass-select" required>
                  <option value="">Selecione o estado primeiro</option>
                </select>
              </div>
              <div style="width:120px">
                <label>CEP *</label>
                <input name="cep" id="cep" maxlength="9" class="glass-input" placeholder="00000-000">
              </div>
            </div>

            <label style="margin-top:8px;">
              <input type="checkbox" id="lembrar_endereco" name="lembrar_endereco">
              Lembrar endere√ßo de entrega
            </label>
          </div>
        </div>
      </div>

      <!-- RIGHT: RESUMO + PAGAMENTO -->
      <div style="width:360px;">
        <h3>Resumo</h3>
        <div class="glass-card" style="padding:14px; border-radius:10px;">
          {% if itens %}
            {% for item in itens %}
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
              <img src="{{ item.imagem_principal }}" alt="{{ item.nome }}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
              <div style="flex:1">
                <div style="font-weight:600;">{{ item.nome }}</div>
                <div style="font-size:0.85rem; color:var(--texto); opacity:0.75;">
                  Qtd: {{ item.quantidade }}
                  {% if item.cor and item.cor != '' %} ‚Ä¢ Cor: {{ item.cor }}{% endif %}
                </div>
              </div>
              <div style="font-weight:600;">R$ {{ "%.2f"|format(item.preco * item.quantidade) }}</div>
            </div>
            {% endfor %}
          {% else %}
            <p>Sem itens.</p>
          {% endif %}

          <hr>

          <div style="display:flex; justify-content:space-between;">
            <div>Subtotal</div>
            <div>R$ {{ "%.2f"|format(subtotal) }}</div>
          </div>
          
          <div style="display:flex; justify-content:space-between; margin-top:6px;">
            <div>Frete</div>
            <div id="freteDisplay">
              R$ {{ "%.2f"|format(frete) }}
            </div>
          </div>
          
          {% if cupom_info %}
          <div style="display:flex; justify-content:space-between; margin-top:6px; color: #28a745;">
            <div>Desconto ({{ cupom_info.codigo }})</div>
            <div>- R$ {{ "%.2f"|format(desconto) }}</div>
          </div>
          {% endif %}
          
          <div style="display:flex; justify-content:space-between; margin-top:8px; font-weight:700;">
            <div>Total</div>
            <div id="totalDisplay">R$ {{ "%.2f"|format(total) }}</div>
          </div>
        </div>

        <h3 style="margin-top:20px;">M√©todo de pagamento</h3>
        
        <!-- M√©todos salvos + PIX padr√£o -->
        <div class="glass-card" style="padding:12px; border-radius:10px; margin-bottom:12px;">
          <strong style="display:block; margin-bottom:8px;">Selecione o m√©todo</strong>
          
          <!-- PIX sempre dispon√≠vel -->
          <label class="saved-pay-label" style="display:block; margin-bottom:6px; border:1px solid var(--border); padding:10px; border-radius:8px; cursor:pointer; transition: all 0.2s;">
            <input type="radio" name="pagamento_selecionado" value="pix_padrao" data-tipo="PIX" style="margin-right:8px;" checked>
            üî∑ PIX (gerar√° QR Code)
          </label>
          
          <!-- M√©todos salvos do usu√°rio -->
          {% if session.usuario_id and pagamentos %}
            {% for p in pagamentos %}
            <label class="saved-pay-label" style="display:block; margin-bottom:6px; border:1px solid var(--border); padding:10px; border-radius:8px; cursor:pointer; transition: all 0.2s;">
              <input type="radio" name="pagamento_selecionado" value="{{ p.id }}" data-tipo="{{ p.tipo }}" data-nome="{{ p.nome_impresso|default('') }}" data-validade="{{ p.validade|default('') }}" data-pix="{{ p.chave_pix|default('') }}" data-permite-parcelamento="{{ p.permite_parcelamento|default('0') }}" style="margin-right:8px;">
              {% if p.tipo == 'PIX' %}
                üî∑ PIX Salvo ‚Äî <small>{{ p.chave_pix }}</small>
              {% else %}
                üí≥ {{ p.nome_impresso or 'Cart√£o' }} ‚Äî <small>{{ p.numero_mascarado }}</small>
              {% endif %}
            </label>
            {% endfor %}
          {% endif %}
          
          <!-- Op√ß√£o para adicionar novo -->
          <label style="display:block; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); cursor:pointer;">
            <input type="radio" name="pagamento_selecionado" value="novo" data-tipo="CARTAO" style="margin-right:8px;"> ‚ûï Adicionar novo m√©todo (Cart√£o)
          </label>
        </div>

        <!-- Novo m√©todo - apenas cart√£o -->
        <div class="glass-card" id="novoCartaoBox" style="padding:12px; border-radius:10px; display:none; margin-bottom:12px;">
          <strong style="display:block; margin-bottom:12px;">Dados do Cart√£o</strong>
          <input type="hidden" name="metodo_pagamento" value="CARTAO">
          
          <label>N√∫mero do cart√£o</label>
          <input name="cartao_num" id="cartao_num" maxlength="19" class="glass-input" placeholder="0000 0000 0000 0000">

          <label>Nome no cart√£o</label>
          <input name="cartao_nome" id="cartao_nome" class="glass-input" placeholder="NOME DO TITULAR">

          <div style="display:flex; gap:8px;">
            <input name="cartao_validade" id="cartao_validade" placeholder="MM/AA" class="glass-input" style="flex:1;">
            <input name="cartao_cvv" id="cartao_cvv" placeholder="CVV" maxlength="4" class="glass-input" style="width:100px;">
          </div>
          
          <label style="margin-top:12px;">
            <input type="checkbox" name="lembrar_pagamento" id="lembrar_pagamento">
            Salvar este m√©todo para pr√≥ximas compras
          </label>
        </div>

        <!-- üí≥ SELETOR DE PARCELAS (NOVO) -->
        <div id="parcelas-container" style="display:none; margin-bottom:12px;">
          <div class="glass-card" style="padding:16px; border-radius:10px; background:rgba(0,123,255,0.03);">
            <h4 style="margin:0 0 12px 0; font-size:1rem; display:flex; align-items:center; gap:8px;">
              üí≥ Parcelamento
            </h4>
            
            <label style="display:block; margin-bottom:8px; font-weight:500; font-size:0.9rem;">
              N√∫mero de Parcelas
            </label>
            
            <select name="parcelas" id="parcelas-select" 
                    class="glass-input glass-select"
                    style="width:100%; padding:12px; border-radius:8px; margin-bottom:12px; cursor:pointer; font-weight:500;">
              <option value="1">1x de R$ 0,00 sem juros</option>
            </select>
            
            <div style="padding:12px; background:rgba(0,200,100,0.05); border-radius:8px; border:1px solid rgba(0,200,100,0.2);">
              <p id="info-parcela" style="margin:0; font-size:0.9rem; text-align:center; color:var(--texto);">
                ‚úì Parcelamento sem juros
              </p>
            </div>
            
            <p style="margin:12px 0 0 0; font-size:0.8rem; color:var(--texto); opacity:0.6; text-align:center;">
              üìå Parcela m√≠nima de R$ 10,00
            </p>
          </div>
        </div>

        <button type="submit" id="realizarBtn" class="btn-primary" style="margin-top:16px; width:100%;">
          Realizar compra
        </button>
      </div>
    </div>
  </form>
</div>

<!-- CONTINUA NA PARTE 2 -->
<style>

/* Glass Card */
.glass-card{
  background: var(--card-bg);
  border: 1px solid var(--border);
  box-shadow: 0 6px 20px var(--shadow);
}

/* Glass Input */
.glass-input{
  width:100%;
  padding:10px;
  margin:6px 0 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background: transparent;
  color: var(--texto);
  outline:none;
  transition: border 0.2s;
}

.glass-input:focus{
  border-color: var(--azul);
}

/* Estiliza√ß√£o espec√≠fica para selects */
.glass-select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 20px;
  padding-right: 35px;
  cursor: pointer;
}

/* Modo claro - Select */
body:not(.dark) .glass-select {
  background-color: #ffffff;
  color: #333333;
  border: 1px solid #d1d5db;
}

body:not(.dark) .glass-select option {
  background-color: #ffffff;
  color: #333333;
}

/* Modo escuro - Select */
body.dark .glass-select {
  background-color: #2d2d2d !important;
  color: #e0e0e0 !important;
  border: 1px solid #444 !important;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
}

body.dark .glass-select option {
  background-color: #2d2d2d !important;
  color: #e0e0e0 !important;
}

/* Corre√ß√£o do dropdown select no modo escuro */
body.dark select:focus,
body.dark .glass-select:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.4);
}

/* Remove background branco do select dropdown no modo escuro */
body.dark select option,
body.dark .glass-select option {
  background: #2d2d2d;
  color: #e0e0e0;
}

/* Bot√£o Primary */
.btn-primary{
  padding:14px 24px;
  border-radius:12px;
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: #ffffff;
  border: none;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
  position: relative;
  overflow: hidden;
}

.btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
}

.btn-primary:hover::before {
  left: 100%;
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* Modo escuro - Bot√£o */
body.dark .btn-primary {
  background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
  box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
}

body.dark .btn-primary:hover {
  background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
  box-shadow: 0 6px 20px rgba(13, 110, 253, 0.5);
}

/* Labels salvos */
.saved-label:hover, .saved-pay-label:hover{
  background: rgba(0,0,0,0.03);
}

body.dark .saved-label:hover, 
body.dark .saved-pay-label:hover{
  background: rgba(255,255,255,0.05);
}

.saved-pay-label:has(input:checked) {
  border-color: var(--azul) !important;
  background: rgba(0, 123, 255, 0.05);
}

/* Anima√ß√£o do container de parcelas */
#parcelas-container {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
<!-- JS -->
<!-- JS -->
<script>
  // ---------- M√ÅSCARAS ----------
  function maskCPF(v){
    v = v.replace(/\D/g,'').slice(0,11);
    v = v.replace(/(\d{3})(\d)/,'$1.$2');
    v = v.replace(/(\d{3})(\d)/,'$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');
    return v;
  }
  function maskTel(v){
    v = v.replace(/\D/g,'').slice(0,11);
    if(v.length <= 10){
      v = v.replace(/(\d{2})(\d)/,'($1) $2');
      v = v.replace(/(\d{4})(\d)/,'$1-$2');
    } else {
      v = v.replace(/(\d{2})(\d)/,'($1) $2');
      v = v.replace(/(\d{5})(\d)/,'$1-$2');
    }
    return v;
  }
  function maskCEP(v){
    v = v.replace(/\D/g,'').slice(0,8);
    v = v.replace(/(\d{5})(\d{1,3})/,'$1-$2');
    return v;
  }
  function maskCard(v){
    v = v.replace(/\D/g,'').slice(0,16);
    return v.replace(/(\d{4})(?=\d)/g,'$1 ');
  }
  function maskMMYY(v){
    v = v.replace(/\D/g,'').slice(0,4);
    v = v.replace(/(\d{2})(\d{1,2})/,'$1/$2');
    return v;
  }
  
  // ---------- API IBGE ----------
  async function carregarEstados() {
    const estadoSelect = document.getElementById("estado");
    const cidadeSelect = document.getElementById("cidade");
  
    const urlEstados = "https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome";
    const estados = await fetch(urlEstados).then(r => r.json());
  
    estadoSelect.innerHTML = '<option value="">Selecione...</option>';
    estados.forEach(estado => {
      const option = document.createElement("option");
      option.value = estado.sigla;
      option.textContent = estado.nome;
      estadoSelect.appendChild(option);
    });
  
    estadoSelect.addEventListener("change", async () => {
      if (!estadoSelect.value) {
        cidadeSelect.innerHTML = '<option value="">Selecione o estado primeiro</option>';
        return;
      }
      cidadeSelect.innerHTML = "<option>Carregando...</option>";
      const urlCidades = `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estadoSelect.value}/municipios?orderBy=nome`;
      const cidades = await fetch(urlCidades).then(r => r.json());
  
      cidadeSelect.innerHTML = '<option value="">Selecione...</option>';
      cidades.forEach(cidade => {
        const option = document.createElement("option");
        option.value = cidade.nome;
        option.textContent = cidade.nome;
        cidadeSelect.appendChild(option);
      });
    });
  }
  
  // ---------- MAIN ----------
  document.addEventListener("DOMContentLoaded", () => {
    carregarEstados();
  
    // M√°scaras
    const cpf = document.getElementById('cpf');
    const tel = document.getElementById('telefone');
    const cep = document.getElementById('cep');
    const card = document.getElementById('cartao_num');
    const val = document.getElementById('cartao_validade');
  
    if(cpf) cpf.addEventListener('input', e => e.target.value = maskCPF(e.target.value));
    if(tel) tel.addEventListener('input', e => e.target.value = maskTel(e.target.value));
    if(cep) cep.addEventListener('input', e => e.target.value = maskCEP(e.target.value));
    if(card) card.addEventListener('input', e => e.target.value = maskCard(e.target.value));
    if(val) val.addEventListener('input', e => e.target.value = maskMMYY(e.target.value));
  
    const enderecoFormWrapper = document.getElementById('enderecoFormWrapper');
    const novoCartaoBox = document.getElementById('novoCartaoBox');
  
    // ========== VALORES DO RESUMO ==========
    const valorTotalStr = "{{ '%.2f'|format(total) }}";
    const subtotal = parseFloat("{{ '%.2f'|format(subtotal) }}".replace(',', '.'));
    const descontoAplicado = parseFloat("{{ '%.2f'|format(desconto if desconto else 0) }}".replace(',', '.'));
    let valorTotalAtual = parseFloat(valorTotalStr.replace(',', '.'));
    
    console.log("üí∞ Valores iniciais - Subtotal:", subtotal, "Desconto:", descontoAplicado, "Total:", valorTotalAtual);
    
    // ‚úÖ FUN√á√ÉO PARA ATUALIZAR FRETE
    function atualizarFrete() {
      const estadoSelecionado = document.getElementById('estado').value;
      const enderecoSalvoRadio = document.querySelector('input[name="endereco_selecionado"]:checked');
      
      let estadoFinal = '';
      
      if (enderecoSalvoRadio && enderecoSalvoRadio.value !== 'novo') {
        estadoFinal = enderecoSalvoRadio.getAttribute('data-estado') || '';
      } else {
        estadoFinal = estadoSelecionado;
      }
      
      let frete = 12.00;
      
      if (estadoFinal.toUpperCase() === 'SC' && subtotal > 129.90) {
        frete = 0.00;
        document.getElementById('freteDisplay').innerHTML = '<span style="color: #28a745; font-weight: 600;">GR√ÅTIS</span>';
      } else {
        document.getElementById('freteDisplay').textContent = 'R$ ' + frete.toFixed(2);
      }
      
      valorTotalAtual = subtotal + frete - descontoAplicado;
      document.getElementById('totalDisplay').textContent = 'R$ ' + valorTotalAtual.toFixed(2);
      
      // ‚úÖ Atualizar parcelas SE estiver vis√≠vel
      atualizarParcelas();
      
      console.log(`üîç Estado="${estadoFinal}", Subtotal=${subtotal.toFixed(2)}, Frete=${frete.toFixed(2)}, Total=${valorTotalAtual.toFixed(2)}`);
    }
  
    // ========== üí≥ SISTEMA DE PARCELAMENTO ==========
    const parcelasContainer = document.getElementById('parcelas-container');
    const parcelasSelect = document.getElementById('parcelas-select');
    const infoParcela = document.getElementById('info-parcela');
    
    const maxParcelas = 12;
    const parcelaMinima = 10.00;
    
    function atualizarParcelas() {
      // ‚úÖ S√ì atualiza se o container estiver VIS√çVEL
      if (!parcelasContainer || parcelasContainer.style.display === 'none') {
        return;
      }
      
      let numParcelas = Math.min(maxParcelas, Math.floor(valorTotalAtual / parcelaMinima));
      if (numParcelas < 1) numParcelas = 1;
      
      console.log("üìä Atualizando parcelas - Total:", valorTotalAtual, "Num Parcelas:", numParcelas);
      
      parcelasSelect.innerHTML = '';
      
      for (let i = 1; i <= numParcelas; i++) {
        const valorParcela = (valorTotalAtual / i).toFixed(2);
        const option = document.createElement('option');
        option.value = i;
        
        if (i === 1) {
          option.text = `√Ä vista - R$ ${valorParcela}`;
        } else {
          option.text = `${i}x de R$ ${valorParcela} sem juros`;
        }
        
        parcelasSelect.appendChild(option);
      }
      
      atualizarInfoParcela();
    }
    
    function atualizarInfoParcela() {
      const parcelas = parseInt(parcelasSelect.value);
      const valorParcela = (valorTotalAtual / parcelas).toFixed(2);
      
      if (parcelas === 1) {
        infoParcela.innerHTML = `‚úì Pagamento √† vista`;
      } else {
        infoParcela.innerHTML = `‚úì Total: ${parcelas}x de R$ ${valorParcela} = R$ ${valorTotalAtual.toFixed(2)}`;
      }
    }
    
    if (parcelasSelect) {
      parcelasSelect.addEventListener('change', atualizarInfoParcela);
    }
  
    // ========== ENDERE√áO ==========
    const enderecosRadios = document.querySelectorAll('input[name="endereco_selecionado"]');
    if (enderecosRadios.length > 0) {
      const primeiroEndereco = enderecosRadios[0];
      if (primeiroEndereco.checked && primeiroEndereco.value !== 'novo') {
        enderecoFormWrapper.style.display = 'none';
        document.getElementById('rua').required = false;
        document.getElementById('numero').required = false;
        document.getElementById('estado').required = false;
        document.getElementById('cidade').required = false;
        document.getElementById('cep').required = false;
        
        atualizarFrete();
      }
    }
  
    document.querySelectorAll('input[name="endereco_selecionado"]').forEach(r => {
      r.addEventListener('change', () => {
        const selected = document.querySelector('input[name="endereco_selecionado"]:checked').value;
        if (selected === 'novo') {
          enderecoFormWrapper.style.display = 'block';
          document.getElementById('rua').required = true;
          document.getElementById('numero').required = true;
          document.getElementById('estado').required = true;
          document.getElementById('cidade').required = true;
          document.getElementById('cep').required = true;
        } else {
          enderecoFormWrapper.style.display = 'none';
          document.getElementById('rua').required = false;
          document.getElementById('numero').required = false;
          document.getElementById('estado').required = false;
          document.getElementById('cidade').required = false;
          document.getElementById('cep').required = false;
        }
        
        atualizarFrete();
      });
    });
    
    const estadoSelect = document.getElementById('estado');
    if (estadoSelect) {
      estadoSelect.addEventListener('change', atualizarFrete);
    }
  
    // ========== ‚úÖ PAGAMENTO + PARCELAMENTO (CORRIGIDO) ==========
    document.querySelectorAll('input[name="pagamento_selecionado"]').forEach(r => {
      r.addEventListener('change', () => {
        const sel = document.querySelector('input[name="pagamento_selecionado"]:checked');
        const tipo = sel.getAttribute('data-tipo');
        
        console.log('üîÑ M√©todo selecionado:', sel.value, 'Tipo:', tipo);
        
        // Mostrar/ocultar formul√°rio de novo cart√£o
        if (sel.value === 'novo') {
          novoCartaoBox.style.display = 'block';
        } else {
          novoCartaoBox.style.display = 'none';
        }
        
        // ‚úÖ MOSTRAR PARCELAS APENAS PARA CART√ÉO
        if (tipo === 'CARTAO' || sel.value === 'novo') {
          console.log('üí≥ Mostrando parcelamento para CART√ÉO');
          parcelasContainer.style.display = 'block';
          atualizarParcelas(); // Atualiza as op√ß√µes
        } else {
          // PIX ou outro m√©todo - ESCONDER parcelas
          console.log('üî∑ Escondendo parcelamento (PIX selecionado)');
          parcelasContainer.style.display = 'none';
        }
      });
    });
    
    // ‚úÖ INICIALIZAR: verificar qual m√©todo est√° selecionado ao carregar
    const metodoInicial = document.querySelector('input[name="pagamento_selecionado"]:checked');
    if (metodoInicial) {
      const tipoInicial = metodoInicial.getAttribute('data-tipo');
      
      // Se for PIX (padr√£o), esconder parcelas
      if (tipoInicial === 'PIX') {
        parcelasContainer.style.display = 'none';
        console.log('üî∑ Inicializado com PIX - parcelas escondidas');
      } else if (tipoInicial === 'CARTAO') {
        parcelasContainer.style.display = 'block';
        atualizarParcelas();
        console.log('üí≥ Inicializado com CART√ÉO - parcelas vis√≠veis');
      }
    }
  
    // ========== SUBMIT ==========
    const form = document.getElementById('checkoutForm');
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const pagoSel = document.querySelector('input[name="pagamento_selecionado"]:checked');
      
      if (!pagoSel) {
        alert('Por favor, selecione um m√©todo de pagamento.');
        return;
      }
      
      if (pagoSel.value === 'novo') {
        const cartaoNum = document.getElementById('cartao_num').value.replace(/\s/g, '');
        const cartaoNome = document.getElementById('cartao_nome').value.trim();
        const cartaoVal = document.getElementById('cartao_validade').value.trim();
        const cartaoCVV = document.getElementById('cartao_cvv').value.trim();
        
        if (!cartaoNum || cartaoNum.length < 12) {
          alert('N√∫mero do cart√£o inv√°lido.');
          return;
        }
        if (!cartaoNome) {
          alert('Informe o nome no cart√£o.');
          return;
        }
        if (!cartaoVal || cartaoVal.length !== 5) {
          alert('Informe a validade (MM/AA).');
          return;
        }
        if (!cartaoCVV || cartaoCVV.length < 3) {
          alert('Informe o CVV.');
          return;
        }
      }
      
      const endSel = document.querySelector('input[name="endereco_selecionado"]:checked');
      if (endSel && endSel.value === 'novo') {
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
      }
      
      console.log('‚úÖ Formul√°rio v√°lido - enviando...');
      form.submit();
    });
  });
  </script>
  
  
  {% endblock %}