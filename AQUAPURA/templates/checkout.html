{% extends "base.html" %}
{% block title %}Checkout - AQUAPURA{% endblock %}

{% block content %}
<div style="max-width:1000px; margin:36px auto; padding:20px;">
  <h2>Finalizar Pedido</h2>

  <form id="checkoutForm" method="post" action="{{ url_for('checkout') }}">
    <div style="display:flex; gap:24px; flex-wrap:wrap;">
      <!-- LEFT: DADOS DO CLIENTE -->
      <div style="flex:1; min-width:320px;">

        <div class="glass-card" style="padding:18px; border-radius:12px;">
          <label>Nome completo *</label>
          <input name="nome" id="nome" required class="glass-input" value="{{ session.get('usuario_nome','') }}">

          <label>CPF *</label>
          <input name="cpf" id="cpf" required maxlength="14" class="glass-input" placeholder="000.000.000-00">

          <label>E-mail *</label>
          <input name="email" id="email" type="email" required class="glass-input" placeholder="seu@exemplo.com" value="{{ session.get('usuario_email','') }}">

          <label>Telefone</label>
          <input name="telefone" id="telefone" class="glass-input" placeholder="(00) 00000-0000" maxlength="15">

          <hr style="margin:12px 0; border:none; border-top:1px solid var(--border)">

          <h4>Endereço para entrega</h4>

          <!-- Se usuário logado e tiver endereços, mostrar opções salvas -->
          {% if session.usuario_id and enderecos %}
          <div style="margin-bottom:10px;">
            <strong>Usar endereço salvo</strong>
            <div style="margin-top:8px;">
              {% for e in enderecos %}
              <label class="saved-label" style="display:block; margin-bottom:6px; border:1px solid var(--border); padding:8px; border-radius:8px; cursor:pointer;">
                <input type="radio" name="endereco_selecionado" value="{{ e.id }}" data-rua="{{ e.rua|e }}" data-numero="{{ e.numero|e }}" data-bairro="{{ e.bairro|e }}" data-cidade="{{ e.cidade|e }}" data-estado="{{ e.estado|e }}" data-cep="{{ e.cep|e }}" style="margin-right:8px;">
                <strong>{{ e.nome_destinatario }}</strong> — {{ e.rua }}, {{ e.numero }} {% if e.bairro %} - {{ e.bairro }}{% endif %} — {{ e.cidade }}/{{ e.estado }} • CEP {{ e.cep }}
              </label>
              {% endfor %}
              <label style="display:block; margin-top:6px; cursor:pointer;">
                <input type="radio" name="endereco_selecionado" value="novo" checked style="margin-right:8px;"> Usar/Inserir novo endereço
              </label>
            </div>
          </div>
          {% endif %}

          <!-- Formulário de endereço (agora pode ser escondido se usar endereço salvo) -->
          <div id="enderecoFormWrapper">
            <label>Rua *</label>
            <input name="rua" id="rua" required class="glass-input" placeholder="Av. Exemplo">

            <div style="display:flex; gap:8px;">
              <div style="flex:1">
                <label>Número *</label>
                <input name="numero" id="numero" required class="glass-input" placeholder="123">
              </div>
              <div style="flex:1">
                <label>Bairro</label>
                <input name="bairro" id="bairro" class="glass-input" placeholder="Centro">
              </div>
            </div>

            <div style="display:flex; gap:8px; margin-top:8px;">
              <div style="flex:1">
                <label>Estado *</label>
                <select name="estado" id="estado" required class="glass-input"></select>
              </div>
              <div style="flex:2">
                <label>Cidade *</label>
                <select name="cidade" id="cidade" required class="glass-input"></select>
              </div>
              <div style="width:120px">
                <label>CEP *</label>
                <input name="cep" id="cep" required maxlength="9" class="glass-input" placeholder="00000-000">
              </div>
            </div>

            <label style="margin-top:8px;">
              <input type="checkbox" id="lembrar_endereco" name="lembrar_endereco">
              Lembrar endereço de entrega
            </label>
          </div>
        </div>
      </div>

      <!-- RIGHT: RESUMO + PAGAMENTO -->
      <div style="width:360px;">
        <h3>Resumo</h3>
        <div class="glass-card" style="padding:14px; border-radius:10px;">
          {% if itens %}
            {% for item in itens %}
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
              <img src="{{ item.imagem_principal }}" alt="{{ item.nome }}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
              <div style="flex:1">
                <div style="font-weight:600;">{{ item.nome }}</div>
                <div style="font-size:0.85rem; color:var(--texto); opacity:0.75;">
                  Qtd: {{ item.quantidade }}
                  {% if item.cor and item.cor != '' %} • Cor: {{ item.cor }}{% endif %}
                </div>
              </div>
              <div style="font-weight:600;">R$ {{ "%.2f"|format(item.preco * item.quantidade) }}</div>
            </div>
            {% endfor %}
          {% else %}
            <p>Sem itens.</p>
          {% endif %}

          <hr>

          <div style="display:flex; justify-content:space-between;">
            <div>Subtotal</div>
            <div>R$ {{ "%.2f"|format(subtotal) }}</div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:6px;">
            <div>Frete</div>
            <div>R$ {{ "%.2f"|format(frete) }}</div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:8px; font-weight:700;">
            <div>Total</div>
            <div>R$ {{ "%.2f"|format(total) }}</div>
          </div>
        </div>

        <h3 style="margin-top:14px;">Método de pagamento</h3>
        <div class="glass-card" style="padding:12px; border-radius:10px;">
          <!-- Se usuário logado e tiver métodos salvos, mostre-os -->
          {% if session.usuario_id and pagamentos %}
          <div style="margin-bottom:10px;">
            <strong>Usar método salvo</strong>
            <div style="margin-top:8px;">
              {% for p in pagamentos %}
              <label class="saved-pay-label" style="display:block; margin-bottom:6px; border:1px solid var(--border); padding:8px; border-radius:8px; cursor:pointer;">
                <input type="radio" name="pagamento_selecionado" value="{{ p.id }}" data-tipo="{{ p.tipo }}" data-nome="{{ p.nome_impresso|default('') }}" data-validade="{{ p.validade|default('') }}" data-pix="{{ p.chave_pix|default('') }}" style="margin-right:8px;">
                {% if p.tipo == 'PIX' %}
                  PIX — <small>{{ p.chave_pix }}</small>
                {% else %}
                  Cartão — <small>{{ p.numero_mascarado }}</small> • {{ p.nome_impresso or '' }}
                {% endif %}
              </label>
              {% endfor %}
              <label style="display:block; margin-top:6px; cursor:pointer;">
                <input type="radio" name="pagamento_selecionado" value="novo" checked style="margin-right:8px;"> Usar/Inserir novo método
              </label>
            </div>
          </div>
          {% endif %}

          <label style="display:block; margin-bottom:8px;">
            <input type="radio" name="metodo_pagamento" value="PIX" required> PIX (gerará QR)
          </label>
          <label style="display:block; margin-bottom:8px;">
            <input type="radio" name="metodo_pagamento" value="CARTAO"> Cartão de Crédito
          </label>

          <div id="cartaoBox" style="display:none; margin-top:10px;">
            <label>Número do cartão</label>
            <input name="cartao_num" id="cartao_num" maxlength="19" class="glass-input" placeholder="0000 0000 0000 0000">

            <label>Nome no cartão</label>
            <input name="cartao_nome" id="cartao_nome" class="glass-input" placeholder="NOME DO TITULAR">

            <div style="display:flex; gap:8px;">
              <input name="cartao_validade" id="cartao_validade" placeholder="MM/AA" class="glass-input" style="flex:1;">
              <input name="cartao_cvv" id="cartao_cvv" placeholder="CVV" maxlength="4" class="glass-input" style="width:100px;">
            </div>
          </div>

          <label style="margin-top: 10px;">
            <input type="checkbox" name="lembrar_pagamento" id="lembrar_pagamento">
            Lembrar método de pagamento
          </label>

          <button type="submit" id="realizarBtn" class="btn-primary" style="margin-top:10px; width:100%;">Realizar compra</button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Styles -->
<style>
.glass-card{
  background: var(--card-bg);
  border: 1px solid var(--border);
  box-shadow: 0 6px 20px var(--shadow);
}
.glass-input{
  width:100%;
  padding:10px;
  margin:6px 0 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background: transparent;
  color: var(--texto);
  outline:none;
}
.btn-primary{
  padding:12px;
  border-radius:10px;
  background:var(--azul);
  color:var(--card-bg);
  border:none;
  font-weight:700;
  cursor:pointer;
}
.btn-primary:hover{ filter:brightness(.95); }

.saved-label:hover, .saved-pay-label:hover{
  background: rgba(0,0,0,0.03);
}

body.dark select {
  background-color: #1e1e1e !important;
  color: #fff !important;
  border: 1px solid #444 !important;
}
</style>

<!-- JS -->
<script>
// ---------- MÁSCARAS ----------
function maskCPF(v){
  v = v.replace(/\D/g,'').slice(0,11);
  v = v.replace(/(\d{3})(\d)/,'$1.$2');
  v = v.replace(/(\d{3})(\d)/,'$1.$2');
  v = v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');
  return v;
}
function maskTel(v){
  v = v.replace(/\D/g,'').slice(0,11);
  if(v.length <= 10){
    v = v.replace(/(\d{2})(\d)/,'($1) $2');
    v = v.replace(/(\d{4})(\d)/,'$1-$2');
  } else {
    v = v.replace(/(\d{2})(\d)/,'($1) $2');
    v = v.replace(/(\d{5})(\d)/,'$1-$2');
  }
  return v;
}
function maskCEP(v){
  v = v.replace(/\D/g,'').slice(0,8);
  v = v.replace(/(\d{5})(\d{1,3})/,'$1-$2');
  return v;
}
function maskCard(v){
  v = v.replace(/\D/g,'').slice(0,16);
  return v.replace(/(\d{4})(?=\d)/g,'$1 ');
}
function maskMMYY(v){
  v = v.replace(/\D/g,'').slice(0,4);
  v = v.replace(/(\d{2})(\d{1,2})/,'$1/$2');
  return v;
}

// ---------- API IBGE ----------
async function carregarEstados() {
  const estadoSelect = document.getElementById("estado");
  const cidadeSelect = document.getElementById("cidade");

  const urlEstados = "https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome";
  const estados = await fetch(urlEstados).then(r => r.json());

  estados.forEach(estado => {
    const option = document.createElement("option");
    option.value = estado.sigla;
    option.textContent = estado.nome;
    estadoSelect.appendChild(option);
  });

  estadoSelect.addEventListener("change", async () => {
    cidadeSelect.innerHTML = "<option>Carregando...</option>";
    const urlCidades = `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estadoSelect.value}/municipios?orderBy=nome`;
    const cidades = await fetch(urlCidades).then(r => r.json());

    cidadeSelect.innerHTML = "";
    cidades.forEach(cidade => {
      const option = document.createElement("option");
      option.value = cidade.nome;
      option.textContent = cidade.nome;
      cidadeSelect.appendChild(option);
    });
  });
}

// ---------- HELPERS ----------
function setHiddenField(form, name, value) {
  let el = document.querySelector(`#checkoutForm input[name="${name}"]`);
  if (!value && el) {
    el.remove();
    return;
  }
  if (!el) {
    el = document.createElement('input');
    el.type = 'hidden';
    el.name = name;
    document.getElementById('checkoutForm').appendChild(el);
  }
  el.value = value;
}

// ---------- MAIN ----------
document.addEventListener("DOMContentLoaded", () => {
  carregarEstados(); // apenas IBGE

  const cpf = document.getElementById('cpf');
  const tel = document.getElementById('telefone');
  const cep = document.getElementById('cep');
  const card = document.getElementById('cartao_num');
  const val = document.getElementById('cartao_validade');

  if(cpf) cpf.addEventListener('input', e => e.target.value = maskCPF(e.target.value));
  if(tel) tel.addEventListener('input', e => e.target.value = maskTel(e.target.value));
  if(cep) cep.addEventListener('input', e => e.target.value = maskCEP(e.target.value));
  if(card) card.addEventListener('input', e => e.target.value = maskCard(e.target.value));
  if(val) val.addEventListener('input', e => e.target.value = maskMMYY(e.target.value));

  const cartaoBox = document.getElementById('cartaoBox');
  const enderecoFormWrapper = document.getElementById('enderecoFormWrapper');

  // Mostrar/ocultar campos do cartão quando rádio muda
  document.querySelectorAll('input[name="metodo_pagamento"]').forEach(r => {
    r.addEventListener('change', () => {
      const metodo = r.value;
      // if a saved payment is selected we will keep cartaoBox hidden; only show when user explicitly chooses new CARTAO
      const pagamentoSelecionado = document.querySelector('input[name="pagamento_selecionado"]:checked');
      const usingSavedPayment = pagamentoSelecionado && pagamentoSelecionado.value !== 'novo';
      if (metodo === 'CARTAO') {
        if (!usingSavedPayment) cartaoBox.style.display = 'block';
        else cartaoBox.style.display = 'none';
      } else {
        cartaoBox.style.display = 'none';
      }
    });
  });

  // Toggle behavior for endereco saved radios (click twice -> revert to "novo")
  let lastEndereco = null;
  document.querySelectorAll('input[name="endereco_selecionado"]').forEach(r => {
    r.addEventListener('click', (ev) => {
      // If clicked same as last, toggle back to 'novo'
      if (String(lastEndereco) === String(r.value)) {
        const novo = document.querySelector('input[name="endereco_selecionado"][value="novo"]');
        if (novo) { novo.checked = true; novo.dispatchEvent(new Event('change')); }
        lastEndereco = 'novo';
        return;
      }
      lastEndereco = r.value;
    });
    r.addEventListener('change', () => {
      const selected = document.querySelector('input[name="endereco_selecionado"]:checked').value;
      if (selected === 'novo') {
        // show form and remove hidden address fields
        enderecoFormWrapper.style.display = 'block';
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_id', '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_rua', '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_numero', '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_bairro', '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_cidade', '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_estado', '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_cep', '');
      } else {
        // use saved address: hide form and set hidden fields to submit to server
        const radio = document.querySelector('input[name="endereco_selecionado"]:checked');
        enderecoFormWrapper.style.display = 'none';
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_id', radio.value);
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_rua', radio.dataset.rua || '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_numero', radio.dataset.numero || '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_bairro', radio.dataset.bairro || '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_cidade', radio.dataset.cidade || '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_estado', radio.dataset.estado || '');
        setHiddenField(document.getElementById('checkoutForm'), 'endereco_cep', radio.dataset.cep || '');
        // Ensure "lembrar_endereco" is only sent if user checks box in UI before (we kept the checkbox inside the visible form)
        // If form hidden, the checkbox isn't visible; we won't set it automatically.
      }
    });
  });

  // Toggle behavior for pagamento saved radios (click twice -> revert to "novo")
  let lastPagamento = null;
  document.querySelectorAll('input[name="pagamento_selecionado"]').forEach(r => {
    r.addEventListener('click', () => {
      if (String(lastPagamento) === String(r.value)) {
        const novo = document.querySelector('input[name="pagamento_selecionado"][value="novo"]');
        if (novo) { novo.checked = true; novo.dispatchEvent(new Event('change')); }
        lastPagamento = 'novo';
        return;
      }
      lastPagamento = r.value;
    });
    r.addEventListener('change', () => {
      const sel = document.querySelector('input[name="pagamento_selecionado"]:checked').value;
      // remove hidden payment fields first
      setHiddenField(document.getElementById('checkoutForm'), 'pagamento_id', '');
      setHiddenField(document.getElementById('checkoutForm'), 'pix_chave', '');
      setHiddenField(document.getElementById('checkoutForm'), 'cartao_nome_hidden', '');
      setHiddenField(document.getElementById('checkoutForm'), 'cartao_validade_hidden', '');

      if (sel === 'novo') {
        // show payment form if user chooses new method: leave visible based on selected metodo_pagamento radio
        const metodoChecked = document.querySelector('input[name="metodo_pagamento"]:checked');
        if (metodoChecked && metodoChecked.value === 'CARTAO') cartaoBox.style.display = 'block';
        else cartaoBox.style.display = 'none';
      } else {
        // using saved payment: hide payment form and set hidden fields
        cartaoBox.style.display = 'none';
        const radio = document.querySelector('input[name="pagamento_selecionado"]:checked');
        setHiddenField(document.getElementById('checkoutForm'), 'pagamento_id', radio.value);
        if (radio.dataset.tipo === 'PIX') {
          // set metodo_pagamento radio to PIX and set pix_chave hidden
          const pixRadio = document.querySelector('input[name="metodo_pagamento"][value="PIX"]');
          if (pixRadio) { pixRadio.checked = true; pixRadio.dispatchEvent(new Event('change')); }
          setHiddenField(document.getElementById('checkoutForm'), 'pix_chave', radio.dataset.pix || '');
        } else if (radio.dataset.tipo === 'CARTAO') {
          // set metodo_pagamento radio to CARTAO
          const cartRadio = document.querySelector('input[name="metodo_pagamento"][value="CARTAO"]');
          if (cartRadio) { cartRadio.checked = true; cartRadio.dispatchEvent(new Event('change')); }
          // fill only non-sensitive fields in hidden inputs
          setHiddenField(document.getElementById('checkoutForm'), 'cartao_nome_hidden', radio.dataset.nome || '');
          setHiddenField(document.getElementById('checkoutForm'), 'cartao_validade_hidden', radio.dataset.validade || '');
        }
      }
    });
  });

  // When user explicitly changes metodo_pagamento to CARTAO, show cartaoBox if not using a saved payment
  document.querySelectorAll('input[name="metodo_pagamento"]').forEach(r => {
    r.addEventListener('change', () => {
      const pagamentoSelecionado = document.querySelector('input[name="pagamento_selecionado"]:checked');
      const usingSaved = pagamentoSelecionado && pagamentoSelecionado.value !== 'novo';
      if (r.value === 'CARTAO') {
        if (!usingSaved) cartaoBox.style.display = 'block';
        else cartaoBox.style.display = 'none';
      } else {
        cartaoBox.style.display = 'none';
      }
    });
  });

  // Ensure initial state matches 'novo' (if any)
  const pagoInit = document.querySelector('input[name="pagamento_selecionado"]:checked');
  if (pagoInit && pagoInit.value !== 'novo') pagoInit.dispatchEvent(new Event('change'));
  const endInit = document.querySelector('input[name="endereco_selecionado"]:checked');
  if (endInit && endInit.value !== 'novo') endInit.dispatchEvent(new Event('change'));

  // When user toggles "lembrar_endereco" while using saved address: it won't do anything here because we hide the checkbox with the hidden form.
  // The checkbox for remembering exists only when the new-address form is visible (per design). If you want a checkbox for saved addresses, we can add it.

});
</script>

{% endblock %}
