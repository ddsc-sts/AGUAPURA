{% extends "base.html" %}

{% block content %}

<div class="perfil-container">

    <!-- Sidebar -->
    <aside class="perfil-sidebar">
        <div class="perfil-user">
            <img src="{{ usuario.avatar or url_for('static', filename='img/user.png') }}" class="perfil-avatar">
            <h3>{{ usuario.nome }}</h3>
        </div>

        <nav class="perfil-menu">
            <button class="perfil-tab active" data-tab="geral">Vis√£o Geral</button>
            <button class="perfil-tab" data-tab="favoritos">Favoritos</button>
            <button class="perfil-tab" data-tab="compras">Hist√≥rico</button>
            <button class="perfil-tab" data-tab="estatisticas">Estat√≠sticas</button>

            {% if usuario.tipo == 'admin' %}
            <a href="/admin" class="perfil-admin">Painel Admin</a>
            {% endif %}
        </nav>
    </aside>

    <!-- Conte√∫do -->
    <section class="perfil-content">

        <!-- VIS√ÉO GERAL -->
        <div id="geral" class="tab-content active">
            <h2>Ol√°, {{ usuario.nome }} üëã</h2>
            <div class="perfil-cards">
                <div class="perfil-card">Total de Compras: <strong id="total-compras"></strong></div>
                <div class="perfil-card">Favoritos: <strong id="total-favoritos"></strong></div>
                <div class="perfil-card">Conta Criada: <strong>{{ usuario.criado_em.strftime("%d/%m/%Y") }}</strong></div>
            </div>
        </div>

        <!-- FAVORITOS -->
        <div id="favoritos" class="tab-content">
            <h2>Favoritos ‚ù§Ô∏è</h2>
            <div class="favoritos-list" id="listaFavoritos"></div>
        </div>

 <!-- HIST√ìRICO DE PEDIDOS -->
<div class="tab-content" id="compras">
    <h2>Hist√≥rico de Pedidos</h2>
    
    <table class="compras-table">
        <tr>
            <th>ID</th>
            <th>Data</th>
            <th>Status</th>
            <th>Valor Total</th>
            <th>M√©todo</th>
        </tr>

        {% for p in pedidos %}
        <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.criado_em.strftime('%d/%m/%Y') }}</td>
            <td>{{ p.status }}</td>
            <td>R$ {{ "%.2f"|format(p.valor_total) }}</td>
            <td>{{ p.pagamento_metodo }}</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="5">Nenhum pedido encontrado.</td>
        </tr>
        {% endfor %}
    </table>
</div>


        <!-- ESTAT√çSTICAS -->
        <div id="estatisticas" class="tab-content">
            <h2>Estat√≠sticas üìä</h2>
            <canvas id="chartCompras"></canvas>
        </div>

    </section>

</div>

<script src="{{ url_for('static', filename='perfil.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    fetch("/api/estatisticas")
        .then(r => r.json())
        .then(dados => {
    
            const meses = dados.map(d => d.mes);
            const totais = dados.map(d => d.total);
    
            new Chart(document.getElementById("chartCompras"), {
                type: "line",
                data: {
                    labels: meses,
                    datasets: [{
                        label: "Pedidos por m√™s",
                        data: totais,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        });
    </script>
    



{% endblock %}

