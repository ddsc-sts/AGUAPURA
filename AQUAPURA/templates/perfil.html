{% extends "base.html" %}

{% block content %}

<div class="perfil-container">

    <!-- Sidebar -->
    <aside class="perfil-sidebar">
        <div class="perfil-user">
            <img src="{{ usuario.avatar or url_for('static', filename='img/user.png') }}" class="perfil-avatar">
            <h3>{{ usuario.nome }}</h3>
        </div>

        <nav class="perfil-menu">
            <button class="perfil-tab active" data-tab="geral">Vis√£o Geral</button>
            <button class="perfil-tab" data-tab="favoritos">Favoritos</button>
            <button class="perfil-tab" data-tab="compras">Hist√≥rico</button>
            <button class="perfil-tab" data-tab="estatisticas">Estat√≠sticas</button>

            {% if usuario.tipo == 'admin' %}
            <a href="/admin" class="perfil-admin">Painel Admin</a>
            {% endif %}
        </nav>
    </aside>

    <!-- Conte√∫do -->
    <section class="perfil-content">

        <!-- VIS√ÉO GERAL -->
        <div id="geral" class="tab-content active">
            <h2>Ol√°, {{ usuario.nome }} üëã</h2>
            <div class="perfil-cards">
                <div class="perfil-card">Total de Compras: <strong id="total-compras"></strong></div>
                <div class="perfil-card">Favoritos: <strong id="total-favoritos"></strong></div>
                <div class="perfil-card">Conta Criada: <strong>{{ usuario.criado_em.strftime("%d/%m/%Y") }}</strong></div>
            </div>
        </div>

        <!-- FAVORITOS -->
        <div id="favoritos" class="tab-content">
            <h2>Favoritos ‚ù§Ô∏è</h2>
            <div class="favoritos-list" id="listaFavoritos"></div>
        </div>

        <!-- HIST√ìRICO DE COMPRAS -->
        <div id="compras" class="tab-content">
            <h2>Hist√≥rico de Compras</h2>
            <table class="compras-table" id="tabelaCompras">
                <tr><th>Data</th><th>Produto</th><th>Qtd</th><th>Valor</th></tr>
            </table>
        </div>

        <!-- ESTAT√çSTICAS -->
        <div id="estatisticas" class="tab-content">
            <h2>Estat√≠sticas üìä</h2>
            <canvas id="chartCompras"></canvas>
        </div>

    </section>

</div>

<script src="{{ url_for('static', filename='perfil.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    // S√≥ cria o gr√°fico se o canvas existir
    const canvas = document.getElementById("chartCompras");
    if (!canvas) return;

    try {
        const response = await fetch("/api/estatisticas");
        const dados = await response.json();

        if (!Array.isArray(dados) || dados.length === 0) {
            canvas.parentElement.innerHTML = "<p>Nenhum dado dispon√≠vel para gerar gr√°fico.</p>";
            return;
        }

        // Transforma m√™s (1-12) em nome
        const nomesMes = [
            "Jan", "Fev", "Mar", "Abr", "Mai", "Jun",
            "Jul", "Ago", "Set", "Out", "Nov", "Dez"
        ];

        const labels = dados.map(item => nomesMes[item.mes - 1]);
        const valores = dados.map(item => item.total);

        new Chart(canvas, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Compras por m√™s",
                    data: valores,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

    } catch (err) {
        console.error("Erro ao carregar dados do gr√°fico:", err);
    }
});
</script>

{% endblock %}

